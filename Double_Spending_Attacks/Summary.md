# 区块链中双花攻击分析


在区块链领域，不管何种区块链系统都面临双花攻击的威胁。区块链中双花攻击会造成很大的经济损失。双花攻击是攻击者利用网络传输延时将相同的一笔钱花费两次，从而获得额外收益。区块链主要包含两种结构：一种是链式结构，通过哈希将区块连接起来形成链式结构；另一种是图结构，利用指针将交易链接成一个有向无环图结构。针对两种不同的结构的双花攻击成功的计算概率将有所不同。本文考虑在完美通信的情况下，不同区块链结构双花攻击成功的概率以及双双话攻击成功时的收益。

## 基于链式结构区块链的双花攻击分析

对于链式结构的区块链，通过将两个具有相同输入的交易打包到区块中，但是最终攻击交易被确认到区块链上实现双花攻击成功。对于这类区块链的双花攻击模型有一般的双花攻击模型和自适应的双花攻击模型。下面分别给出两种攻击模型的分析和计算。

### 双花攻击模型（考虑成功双花攻击的区块数量）

假设是在类似于比特币的区块链系统中讨论双花攻击的模型。我们事先定义一下系统的模型：
1. 系统模型假设
    * 假设系统由 $N$ 个节点构成，并且节点可以随意加入网络；
    * 假设每个节点通过竞争生成区块，并达成一致添加到区块链主链上；
    * 假设节点在固定时期长度中生成区块，一个时期 $T$ 内只能生成一个区块；
    * 系统中的节点可以分成两类：诚实节点和攻击者节点； 
    * 假设攻击节点决定发起双花攻击，会生成一个目标交易，随后生成一个攻击交易；
    * 当确定攻击成功时，攻击者会选择公布伪区块链。

#### 双花攻击成功概率计算
定量分析双花攻击模型：
1. 问题描述
  *  假设攻击者在一个时期中生成区块的概率为$q$，诚实节点在一个时期中生成区块的概率为$p$，且有 $p + q = 1$；
  *  假设诚实链长度为 $n$，欺诈链长度为 $m$，诚实链分支领先 $z = m - n$ 个区块的长度；
  * <font color = red>求解攻击节点生成欺诈链超过诚实链的概率。</font>
2. 定性分析
上述双花攻击过程可以看成是一个连续时间的**马尔可夫过程**，当 $z = -1$ 时攻击成功。在<font color = red>不考虑成功的时间</font>的情况下，只关注成功的概率时上述问题可以等价为一个**离散的马尔可夫过程**.
  * 当诚实链领先欺诈链 $z$ 个区块时，双花攻击成功时，下面关系成立：
    $z^{i + 1}=\left\{
    \begin{aligned}
    z^i + 1 &  & \text{概率为 } p, \\
    z^i -1 &  & \text{概率为 } q.
    \end{aligned}
  \right.\\
  p + q = 1;\\
  a_z = p*a_{z+1} + q*a_{z-1}；\\
  a_{-1} = 1, a_0 = \frac{q}{p}.
  $

  其中<font color = blue> $a_z$ 是欺诈链落后于诚实链 $z$ 个区块攻击成功的概率</font>，因此就有 $a_z = a_{z+1}*p + a_{z-1}*q$, 且 $a_{-1} = 1, a_0 = \frac{q}{p}$。最终计算得到 $a_z = (\frac{q}{p})^{z+1}$。最终推导出攻击者双花攻击成功的概率： 
  $p(z)=\left\{
  \begin{aligned}
  1 &  & \text{if } q \geq p, \\
  a_z = (\frac{q}{p})^{z+1} &  & \text{if } q < p.
  \end{aligned}
  \right.$
  * 当 $q > p$ 时，即攻击节点的算力大于诚实节点的总算力，此时无论欺诈链落后诚实链多少个区块，均可攻击成功,最终生成比诚实链长的链。当 $q < p$ 时，攻击者成功的概率随着落后的区块个数而呈现指数型衰减。攻击节点成功的概率与落后区块个数有关，与生成区块的时间间隔大小无关。由此得出结论，交易信息的真实性，往往需要等待若干个区块确认被写入最长链后才得到保障。
3. 定量分析
通过进行定量分析，计算爽阿胡攻击成功概率的累积分布函数(CDF)。
  *  假设攻击者在一个时期 $T$ 中生成区块的概率为$q$，诚实节点在一个时期 $T$ 中生成区块的概率为$p$，且有 $p + q = 1$；
  *  假设诚实链长度为 $n$，欺诈链长度为 $m$，诚实链分支领先 $z = m - n$ 个区块的长度；

新产生的区块由攻击者节点和诚实节点生成的概率分别为 $q,p(p + q = 1)$。因次一个时期 $T$ 内区块是由谁生成是一个伯努利试验。对于总共 $m+n$ 次试验可以看成是一个 $m+n$ 重伯努利试验，攻击节点成功生成新区块数量 $m$ 是一个随机变量，服从负二项分布，并且概率密度函数(pdf)为 $p(m) = C_{m+n-1}^m p^nq^m$, q < q，由此计算出双花攻击成功的概率为 $P(m) = \sum_{m = 0}^{\infty}p(m) = \sum_{m=0}^{n-1} p(m)\cdot \min(a_{n-m-1},1) + \sum_{m=n}^{\infty} p(m) 
= \left\{
  \begin{aligned}
  1 &  & \text{if } q \geq p, \\
  1 - \sum_{m=0}^{n} C_{m+n-1}^m(p^nq^m - p^mq^n) &  & \text{if } q < p.
  \end{aligned}
  \right.$

根据双花攻击成功的概率分布函数，可以计算出双花攻击成功的概率与攻击者算力、确认区块数量（可以设为 $n$）密切相关。

#### 双花攻击成功收益计算

当节点成功挖出一个区块之后，将获得系统的奖励，而在挖矿过程中也需要消耗资源进行挖矿，因此，我们可以计算节点成功攻击后的收益的变化来分析系统的安全性。

* 当一个节点成功生成一个区块后，其收益主要是挖矿奖励 $R_B$ 和交易费用 $R_b$，但在生成区块的过程中会产生消耗，从而产生一个区块的成本为 $C_b$。在考虑挖矿奖励、交易费用和挖矿成本时，计算双花攻击成功的收益的概率。
* 假设每一笔交易都支付相同的交易费用 $R_f$，区块 $i$ 中对应的交易数量为 $N_T^i$，因此区块 $i$ 的交易总费用为 $R_T^i = R_f* N_T^i$。记双花攻击一笔交易的收益为 $R_p$，成功生成一个区块的系统奖励为 $R_p$，挖掘一个区块的成本是 $C_b(d)$。因此，每个区块的网络奖励为：
      
  $R_{net}(R_b, R_f, R_d, C_b)=\left\{
  \begin{aligned}
  R_b + R_f* N^b_T - C_b&  & \text{if attack successful}, \\
  -C_b &  & \text{otherwise}.
  \end{aligned}
  \right.$
* 当双花攻击成功时，奖励的期望为：

  $\mathbb{E}_{(m,n)}(R_{net}+R_p|R_b,R_f,C_b) = (1 - \sum_{m=0}^{n} C_{m+n-1}^m(p^nq^m - p^mq^n))(R_p+\sum_{i=1}^{m}(R_b + R_f*N_T^i-C_b) + (\sum_{m=0}^{n} C_{m+n-1}^m(p^nq^m - p^mq^n))(-C_b\cdot m) $ 


### 自适应双花攻击模型

#### 双花攻击成功概率计算（考虑攻击成功时间）

攻击者不会无限期的等待攻击成功，因为如果链很长但是最终攻击失败会造成巨大损失，因此攻击者会限制攻击时长从而来减少攻击损失。因此引入了一个结束时间 $t_{cut}\in \mathbb{R}^+$。攻击者会根据攻击成功时间与截止时间的大小来选择是否继续发起攻击，因此这是一个自适应的双花攻击模型。

1. 双花攻击的必要条件：

  <font color = blue>定义1. 双花攻击是成功的，如果存在一个双花攻击实现(DSA)时间$T_{DSA}$使得下面两个条件成立：
  * 区块确认 $\mathcal{G}^{(1)}$：诚实链在 $T_{DSA}$ 时间段内增长的长度要远远长于最长确认区块数量 $N_{BC}$；
  * PoW竞争成功 $\mathcal{G}^{(2)}$：欺诈链在 $T_{DSA}$ 时间段内增长的比诚实链更长。</font>

2. 双花攻击模型假设
  *  假设区块生成过程是一个泊松计数过程（随机过程），生成速率为 $\lambda$。
  *  假设每个区块生成时间 $T$ 内只能生成一个区块；
  *  在 $t$ 时刻的区块由攻击节点还是诚实节点生成是一个随机游走过程；
  *  记初始攻击时间为 $t = 0$，时间 $t = t + i*T, i = 1, 2, \cdots$。在 $t$ 时刻，记欺诈链长度为 $F(t)$，诚实链长度为 $H(t)$，且有 $H(0) = F(0) = 0$。
  *  记 $t$ 时刻的总区块增长数量为 $M(t) = H(t) + F(t) = \lambda \cdot t$，诚实链与欺诈链的差额时一个随机游走的过程，可记作 $S(t) = H(t) - F(t)$。

#### 双花攻击成功收益计算


#### 双花攻击成功概率计算


#### 双花攻击成功收益计算

#### 双花攻击成功概率计算


#### 双花攻击成功收益计算


## 基于DAG结构区块链的双花攻击分析


#### 双花攻击成功概率计算


#### 双花攻击成功收益计算



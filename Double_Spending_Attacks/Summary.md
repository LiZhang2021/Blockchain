# 区块链中双花攻击分析


在区块链领域，不管何种区块链系统都面临双花攻击的威胁。区块链中双花攻击会造成很大的经济损失。双花攻击是攻击者利用网络传输延时将相同的一笔钱花费两次，从而获得额外收益。区块链主要包含两种结构：一种是链式结构，通过哈希将区块连接起来形成链式结构；另一种是图结构，利用指针将交易链接成一个有向无环图结构。针对两种不同的结构的双花攻击成功的计算概率将有所不同。本文考虑在完美通信的情况下，不同区块链结构双花攻击成功的概率以及双双话攻击成功时的收益。

## 基于链式结构区块链的双花攻击分析

对于链式结构的区块链，通过将两个具有相同输入的交易打包到区块中，但是最终攻击交易被确认到区块链上实现双花攻击成功。对于这类区块链的双花攻击模型有一般的双花攻击模型和自适应的双花攻击模型。下面分别给出两种攻击模型的分析和计算。

### 双花攻击模型（考虑成功双花攻击的区块数量）

假设是在类似于比特币的区块链系统中讨论双花攻击的模型。我们事先定义一下系统的模型：
1. 系统模型假设
    * 假设系统由 $N$ 个节点构成，并且节点可以随意加入网络；
    * 假设每个节点通过竞争生成区块，并达成一致添加到区块链主链上；
    * 假设节点在固定时期长度中生成区块，一个时期 $T$ 内只能生成一个区块；
    * 系统中的节点可以分成两类：诚实节点和攻击者节点； 
    * 假设攻击节点决定发起双花攻击，会生成一个目标交易，随后生成一个攻击交易；
    * 当确定攻击成功时，攻击者会选择公布伪区块链。

#### 双花攻击成功概率计算
定量分析双花攻击模型：
1. 问题描述
  *  假设攻击者在一个时期中生成区块的概率为$q$，诚实节点在一个时期中生成区块的概率为$p$，且有 $p + q = 1$；
  *  假设诚实链长度为 $n$，欺诈链长度为 $m$，诚实链分支领先 $z = m - n$ 个区块的长度；
  * <font color = red>求解攻击节点生成欺诈链超过诚实链的概率。</font>
2. 定性分析
上述双花攻击过程可以看成是一个连续时间的**马尔可夫过程**，当 $z = -1$ 时攻击成功。在<font color = red>不考虑成功的时间</font>的情况下，只关注成功的概率时上述问题可以等价为一个**离散的马尔可夫过程**.
  * 当诚实链领先欺诈链 $z$ 个区块时，双花攻击成功时，下面关系成立：
    $z^{i + 1}=\left\{
    \begin{aligned}
    z^i + 1 &  & \text{概率为 } p, \\
    z^i -1 &  & \text{概率为 } q.
    \end{aligned}
  \right.\\
  p + q = 1;\\
  a_z = p*a_{z+1} + q*a_{z-1}；\\
  a_{-1} = 1, a_0 = \frac{q}{p}.
  $

  其中<font color = blue> $a_z$ 是欺诈链落后于诚实链 $z$ 个区块攻击成功的概率</font>，因此就有 $a_z = a_{z+1}*p + a_{z-1}*q$, 且 $a_{-1} = 1, a_0 = \frac{q}{p}$。最终计算得到 $a_z = (\frac{q}{p})^{z+1}$。最终推导出攻击者双花攻击成功的概率： 
  $p(z)=\left\{
  \begin{aligned}
  1 &  & \text{if } q \geq p, \\
  a_z = (\frac{q}{p})^{z+1} &  & \text{if } q < p.
  \end{aligned}
  \right.$
  * 当 $q > p$ 时，即攻击节点的算力大于诚实节点的总算力，此时无论欺诈链落后诚实链多少个区块，均可攻击成功,最终生成比诚实链长的链。当 $q < p$ 时，攻击者成功的概率随着落后的区块个数而呈现指数型衰减。攻击节点成功的概率与落后区块个数有关，与生成区块的时间间隔大小无关。由此得出结论，交易信息的真实性，往往需要等待若干个区块确认被写入最长链后才得到保障。
3. 定量分析
通过进行定量分析，计算爽阿胡攻击成功概率的累积分布函数(CDF)。
  *  假设攻击者在一个时期 $T$ 中生成区块的概率为$q$，诚实节点在一个时期 $T$ 中生成区块的概率为$p$，且有 $p + q = 1$；
  *  假设诚实链长度为 $n$，欺诈链长度为 $m$，诚实链分支领先 $z = m - n$ 个区块的长度；

新产生的区块由攻击者节点和诚实节点生成的概率分别为 $q,p(p + q = 1)$。因次一个时期 $T$ 内区块是由谁生成是一个伯努利试验。对于总共 $m+n$ 次试验可以看成是一个 $m+n$ 重伯努利试验，攻击节点成功生成新区块数量 $m$ 是一个随机变量，服从负二项分布，并且概率密度函数(pdf)为 $p(m) = C_{m+n-1}^m p^nq^m$, q < q，由此计算出双花攻击成功的概率为 $P(m) = \sum_{m = 0}^{\infty}p(m) = \sum_{m=0}^{n-1} p(m)\cdot \min(a_{n-m-1},1) + \sum_{m=n}^{\infty} p(m) 
= \left\{
  \begin{aligned}
  1 &  & \text{if } q \geq p, \\
  1 - \sum_{m=0}^{n} C_{m+n-1}^m(p^nq^m - p^mq^n) &  & \text{if } q < p.
  \end{aligned}
  \right.$

根据双花攻击成功的概率分布函数，可以计算出双花攻击成功的概率与攻击者算力、确认区块数量（可以设为 $n$）密切相关。

#### 双花攻击成功收益计算

当节点成功挖出一个区块之后，将获得系统的奖励，而在挖矿过程中也需要消耗资源进行挖矿，因此，我们可以计算节点成功攻击后的收益的变化来分析系统的安全性。

* 当一个节点成功生成一个区块后，其收益主要是挖矿奖励 $R_B$ 和交易费用 $R_b$，但在生成区块的过程中会产生消耗，从而产生一个区块的成本为 $C_b$。在考虑挖矿奖励、交易费用和挖矿成本时，计算双花攻击成功的收益的概率。
* 假设每一笔交易都支付相同的交易费用 $R_f$，区块 $i$ 中对应的交易数量为 $N_T^i$，因此区块 $i$ 的交易总费用为 $R_T^i = R_f* N_T^i$。记双花攻击一笔交易的收益为 $R_p$，成功生成一个区块的系统奖励为 $R_p$，挖掘一个区块的成本是 $C_b(d)$。因此，每个区块的网络奖励为：
      
  $R_{net}(R_b, R_f, R_d, C_b)=\left\{
  \begin{aligned}
  R_b + R_f* N^b_T - C_b&  & \text{if attack successful}, \\
  -C_b &  & \text{otherwise}.
  \end{aligned}
  \right.$
* 当双花攻击成功时，奖励的期望为：

  $\mathbb{E}_{(m,n)}(R_{net}+R_p|R_b,R_f,C_b) = (1 - \sum_{m=0}^{n} C_{m+n-1}^m(p^nq^m - p^mq^n))(R_p+\sum_{i=1}^{m}(R_b + R_f*N_T^i-C_b) + (\sum_{m=0}^{n} C_{m+n-1}^m(p^nq^m - p^mq^n))(-C_b\cdot m) $ 


### 自适应双花攻击模型

#### 双花攻击成功概率计算（考虑攻击成功时间）

攻击者不会无限期的等待攻击成功，因为如果在较长时间攻击成功后，攻击者也无法获得收益。因此引入了一个切割时间 $t_{cut}\in \mathbb{R}^+$。攻击者会计算双花攻击实现时间 $T_{DSA}$ 的概率分布，根据切割时间为 $t_{cut}$ 的双花攻击成功概率计算出 $T_{DSA} < t_{cut}$ 的概率，由此估计出攻击的收益。当收益较小或者无收益时，理性的攻击者会选择停止攻击。因此，这是一个自适应收益大小的双花攻击模型。

1. 双花攻击的必要条件：

  <font color = blue>定义1. 双花攻击是成功的，如果存在一个双花攻击实现(DSA)时间 $T_{DSA}$ 使得下面两个条件成立：
  * 区块确认 $\mathcal{G}^{(1)}$：诚实链在 $T_{DSA}$ 时间段内增长的长度要远远长于最长确认区块数量 $N_{BC}$；
  * PoW竞争成功 $\mathcal{G}^{(2)}$：欺诈链在 $T_{DSA}$ 时间段内增长的比诚实链更长。</font>

2. 双花攻击模型假设
  区块生成过程可以看作是随机模型中一个给定区块生成速率为 $\lambda$ 的泊松计数过程。因此，诚实链和欺诈链的长度在时间 $t\in(0, \infty]$ 内的增长是两个泊松计数过程，记作 $H(t)$ 的区块生成速率为 $\lambda_H$ 以及 $A(t)$ 的区块生成速率为 $\lambda_A$。初始时间 $t=0$ 时有 $H(0)=A(0)=0$。在一个时间点上，整个系统只能生成一个区块，要么是诚实挖矿者生成要么是攻击者生成。在一个离散时间域中，$H(t)$与$A(t)$的差可以表示一个随机游走过程。
  * 随机过程 $M(t) = H(t)+A(t)$ 是生成率为 $\lambda$ 的泊松计数过程；
  * 随机过程 $S(t) = H(t)-A(t)$ 连续时间内的类随机游走过程。令 $T_i = \inf\{t\in\mathbb{R}^+, M(t) = i\}$ 是状态发展时间，则 $S_i = S(T_i)$ 是 $T_i$ 时刻诚实链和欺诈链的差。随机游走 $S_i$ 是初始 $S_0 = 0$ 的稳定马尔科夫链。
  * 状态转换的概率分别为 $p_A = Pr(S_i = n-1|S_{i-1} = n) = \frac{\lambda_A}{\lambda_T}, p_H = Pr(S_i = n+1|S_{i-1} = n) = \frac{\lambda_H}{\lambda_T}$。
  * 因此，可以定义一个独立同分布状态变换随机变量 $\Delta_i = S_i-S_{i-1}\in\{\pm1\}\sim Bernoulli(p_H)$，且 $S_i = \sum_{k=0}^i\Delta_k$
#### 双花攻击成功概率计算

1. 问题描述
  * 假设系统区块生成速率 $\lambda$；
  * 攻击者在一个时期中生成区块的概率为 $p_A = Pr(S_i = n-1|S_{i-1} = n) = \frac{\lambda_A}{\lambda_T}$，诚实节点在一个时期中生成区块的概率为 $p_H = Pr(S_i = n+1|S_{i-1} = n) = \frac{\lambda_H}{\lambda_T}$，且有 $p_A + q_H = 1$；
  *  假设 $t$ 时刻诚实链长度为 $H(t)$，欺诈链长度为 $A(t)$；
  * <font color = red>求解双花攻击实现时间小于切割时间的概率。</font>
2. 定性分析

双花攻击过程可以看成是一个选取样本 $\omega\in\Omega$ 的随机试验，其中 $\omega = ((T_1,\Delta_1), (T_2,\Delta_2), \dots, (T_\infty,\Delta_\infty))$，集合 $\Omega = \{\omega\in\{\mathbb{R}^+\times\{\pm1\}\}^\infty\}$。对于给定的 $DS$ 样本 $\omega$以及状态指标$i$，投影表示 $\pi_{T_i}(\omega) = T_i, \pi_{\Delta_i}(\omega) = \Delta_i$。
  * 双花攻击实现时间 $T_{DSA} 的概率密度函数需要两个随机事件的概率
    * 状态进程时间 $T_i$ 服从埃尔朗分布 $f_{T_i}(t) = \frac{\lambda_T(\lambda_T t)^{i-1}e^{-\lambda_T t}}{(i-1)!}$；
    * 给定状态指标 $i$ 满足 $\omega\in\mathcal{D}_j^{(1)}\cap\mathcal{D}_{i,j}^{(2)}$。其中集合 $\mathcal{D}_j^{(1)}, \mathcal{D}_{i,j}^{(2)}$ 分别表示满足双花攻击必要条件1和2的双花攻击样本的集合，且有 $j \geq N_{BC}, i \geq j, i,j \in \mathbb{N}$。随机试验的样本 $w$ 同时满足双花攻击成功必要条件的概率为 
    $p_{DSA,i} = Pr(\exist j\in\mathbb{N}: \omega\in\mathcal{D}_j^{(1)}\cap\mathcal{D}_{i,j}^{(2)}) = \sum_{j = N_{BC}}^\infty Pr(\omega\in\mathcal{D}_j^{(1)}\cap\mathcal{D}_{i,j}^{(2)}) = \sum_{j = N_{BC}}^{2N_{BC}}Pr(\omega\in\mathcal{D}_j^{(1)})Pr(\omega\in\mathcal{D}_{i,j}^{(2)}) + \sum_{j = 2N_{BC} + 1}^{\infty}Pr(\omega\in\mathcal{D}_i^{(1)}) = \sum_{j=N_{BC}}^{2N_{BC}}C_{j-1}^{N_{BC}-1}p_H^{N_{BC}}p_A^{j-N_{BC}}\cdot C_{\frac{i-1-2N_{BC}}{2}, 2N_{BC} - j}p_H^{\frac{i-1-2N_{BC}}{2}}p_A^{\frac{i-1-2N_{BC}}{2} + 2N_{BC}-j +1} + \sum_{j = 2N_{BC} + 1}^\infty C_{i-1}^{N_{BC}-1} p_H^{N_{BC}}p_A^{i-N_{BC}} = \sum_{j=N_{BC}}^{2N_{BC}}C_{j-1}^{N_{BC}-1} (C_{i-j-1}^{\frac{i-1-2N_{BC}}{2}}\cdot \frac{2N_{BC}-j+1}{\frac{i+1}{2}+2N_{BC} -j})p_H^{\frac{i-1}{2}}p_A^{\frac{i+1}{2}} + \sum_{j = 2N_{BC} + 1}^\infty C_{i-1}^{N_{BC}-1} p_H^{N_{BC}}p_A^{i-N_{BC}}$ 
3. 定量分析
  * 不考虑成功攻击时间（即切割时间 $t_{cut} = \infty$）时，双花攻击成功概率为 
    $\mathbb{P}_{DSA}=\left\{
    \begin{aligned}
    1 &  & \text{if } p_H\leq p_A, \\
    1-\sum_{j=N_{BC}}^{2N_{BC}}C_{j-1}^{N_{BC}-1}(p_H^{N_{BC}}p_H^{j-N_{BC}} - p_H^{j-N_{BC}-1}p_A^{N_{BC}+1}) &  & \text{if }p_H > p_A.
    \end{aligned}
    \right.$
  * 因此计算得到双花攻击实现时间 $T_{DSA}$ 的概率密度函数为 
    $f_{T_{DSA}}(t) = \sum_{i=2N_{BC}+1}^\infty p_{DSA,i}f_{T_i}(t) + (1-\mathbb{P}_{DSA})\delta(t-\infty)$
    其中 $\delta(t)$ 是狄克雷 $\delta$ 函数。
  * 双花攻击函数在有限时间内成功的概率为：
    $\mathbb{P}_{AS}(t_{cut}) = Pr(T_{DSA} < t_{cut})$
    当$t_{cut} = \infty$时，$\mathbb{P}_{AS}(t_{cut}) = \mathbb{P}_{DSA}$.
  * 双花攻击成功时间的概率密度函数为
    $f_{T_{AS}}(t)=\left\{
    \begin{aligned}
    f_{T_{DSA}}\cdot\mathbb{P}_{AS}^{-1} &  & \text{for } 0 < t < t_{cut}, \\
    0 &  & \text{for } t \geq t_{cut}.
    \end{aligned}
    \right.$
  * 攻击成功时间的期望为 
    $\mathbb{E}_{T_{AS}}(t_{cut}) = \frac{\int_0^{t_{cut}}tf_{T_{DSA}}(t)dt}{\mathbb{P}_{AS}(t_{cut})}$。

#### 双花攻击成功收益计算

  * 根据攻击时间定义收益函数为 
    $P=\left\{
    \begin{aligned}
    C+R(\lambda_A, T_{AS})-X(\lambda_A, T_{AS})&  & \text{if } T_{DSA} < t_{cut}, \\
    -X(\lambda_A, T_{AS}) &  & \text{otherwise}.
    \end{aligned}
    \right.$
    其中 $C$ 是欺诈交易的收益，$R(\lambda_A, T_{AS})$ 是攻击节点生成区块处理交易的奖励函数，$X(\lambda_A, T_{AS})$ 是攻击节点算力租赁费用函数。
  * 攻击者总收益函数的期望为 
    $\mathbb{E}_P = \mathbb{P}_{AS}(t_{cut})\cdot (C + \mathbb{E}[R(\lambda_A, T_{AS})] - \mathbb{E}[X(\lambda_A, T_{AS})]) - (1- \mathbb{P}_{AS}(t_{cut}))\cdot X(\lambda_A, T_{AS})$。
    攻击者租赁费用函数的期望
    $\mathbb{E}_X = \mathbb{P}_{AS}(t_{cut})\cdot \mathbb{E}[X(\lambda_A, T_{AS})]) + (1- \mathbb{P}_{AS}(t_{cut}))\cdot X(\lambda_A, T_{AS})$。
4. 讨论分析
  * 当 $\mathbb{E}_P > 0$ 时，双花攻击是有收益的。根据收益函数的定义可知，欺诈交易的价值 $C$ 是影响收益的主要因素。目标交易的需求价值可计算为 $C_{req} = \frac{\mathbb{E}_X - \mathbb{P}_{AS}(t_{cut})\cdot \mathbb{E}[R(\lambda_A, T_{AS})]}{\mathbb{P}_{AS}(t_{cut})}$。因此当 $C > C_{req}$ 时攻击者是有收益的。
  * 影响攻击成功的概率 $\mathbb{P}_{AS}$ 、成功攻击时间的期望 $\mathbb{E}_{T_{AS}}$ 、租赁费用的期望 $\mathbb{E}_X$ 、目标交易的需求值 $C_{req}$ 的主要因素有区块确认时间 $N_{BC}$ 和攻击者算力 $p_A$。
    * 攻击成功的概率 $\mathbb{P}_{AS}$ 随着区块确认数量 $N_{BC}$ 的增加而降低。这是因为攻击者需要等到目标交易被确认在诚实链分支上延长欺诈链分支长于诚实链分支才能确认成功。随着确认区块数量增加，需要等待诚实链分支确认目标交易所在区块的时间和成本就高了，根据概率计算公式可知攻击成功的概率会下降；
    * 攻击成功的概率 $\mathbb{P}_{AS}$ 随着攻击者算力比率的增加而增加。这是因为当算力增加后，攻击节点生成区块的概率会增加，由此使得最终攻击成功的概率会增加。
    * 成功攻击时间的期望 $\mathbb{E}_{T_{AS}}$ 会随着区块确认数量 $N_{BC}$ 的增加而增加。攻击者需要等待更长时间才能确定目标交易所在区块被确认到诚实链分支上，因此直接成倍数的增加了攻击时间，因而会使得成功攻击时间的期望 $\mathbb{E}_{T_{AS}}$增加；
    * 成功攻击时间的期望 $\mathbb{E}_{T_{AS}}$ 受到算力的影响没有确认区块数量的影响那么大。这是因为算力主要是影响攻击者生成区块的概率，影响主要是在成功攻击概率上，但概率的取值范围都在 $[0,1]$ 区间内。但确认当确认区块数量是成倍数的影响时间。因此相较而言，成功攻击时间的期望 $\mathbb{E}_{T_{AS}}$ 基本上不受算力的影响。
    * 租赁费用的期望 $\mathbb{E}_X$ 随着确认区块数量的增加而增加。这是因为确认区块数量增加，攻击者需要生成更多的区块来确保攻击成功。这就使得所需要的算力将要增加，由此使得攻击者租赁算力的费用将增加；
    * 租赁费用的期望 $\mathbb{E}_X$ 随着算力的增加而增加。为了提高区块生成概率，就需要更大的算力支撑，从而算力租赁费用就增加了。
    * 目标交易的需求值 $C_{req}$ 随着区块确认数量的增加而增加。根据其计算公式，当确认区块数量增加时，攻击者成功攻击的区块数量会增加，从而导致成本也会增加。于此同时区块的收益也会增加，但是相对于成本威严增加没那么多，因此使得成功攻击时所需要的目标交易的需求值 $C_{req}$ 会增加；
    * 目标交易的需求值 $C_{req}$ 随者算力的增加而降低。当算力增加后，攻击成功的概率会增加，从而会使得成本的期望降低，而收益的期望并不会有太大的变化，由此使得目标交易的需求值 $C_{req}$会降低。


#### 双花攻击成功概率计算


#### 双花攻击成功收益计算


## 基于DAG结构区块链的双花攻击分析


#### 双花攻击成功概率计算


#### 双花攻击成功收益计算



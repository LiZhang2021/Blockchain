# Profitable Double-Spending Attacks 1 (J.Jang&H.Lee, 2019)

[相关论文链接](./../Papers/3.%20Profitable%20Double-Spending%20Attacks(J.Jang&H.Lee,%20Mar.2019).pdf)

## 文章创新点

本文调查了双花攻击的收益，具有任意算力的攻击者都有成功发起双花概念化攻击的机会。只要成功攻击，收益将高于遵守规则的收益。本文提出了一个新的计算有限时间攻击概率定理。可以用于估计获得收益所需的攻击资源。从而
推导出双花攻击所针对交易值的充要条件。给定交易大小，可以通过计算攻击获利来评估双花攻击的风险。

## 模型假设
### 攻击模型

1. 系统中存在两种矿工：单一攻击者和诚实矿工；
2. 假设攻击者决定发起双花攻击，会生成一个目标交易为商品或服务支付金额；
3. 在给攻击者交付商品或提供服务之前，受害者会选择等待部分区块添加到链上；
4. 当确定攻击成功时，攻击者会选择公布伪区块链。
5. 假设理性的攻击者不会无限期的等待攻击成功，因为增加攻击链常会会造成大量算力的消耗；
6. 假设攻击者算力不会超过诚实矿工的算力。
7. 假设任意算力比例的节点发起双花攻击都可获益；
### 随机模型

1. 假设块生成过程是一个泊松计数过程，生成速率为 $\lambda$；
2. 每个时间单位全网只能有一个区块生成；
3. 块生成总数也是是一个泊松计数过程；
4. 在$t$时刻的区块由攻击者还是诚实矿工生成是一个随机游走过程；

## 理论分析

### 双花攻击的必要条件：

定义1. 双花攻击是成功的，如果存在一个双花攻击实现(DSA)时间$T_{DSA}$使得下面两个条件成立：
  * 区块确认 $\mathcal{G}^{(1)}$：诚实链在 $T_{DSA}$ 时间段内增长的长度要远远长于最长确认区块数量 $N_{BC}$；
  * PoW竞争成功 $\mathcal{G}^{(2)}$：欺诈链在 $T_{DSA}$ 时间段内增长的比诚实链更长。

攻击者不会无限期的等待攻击成功，因为如果链很长但是最终攻击失败会造成巨大损失，因此攻击者会限制攻击市场从而来减少攻击损失。因此引入了一个结束时间 $t_{cut}\in \mathbb{R}^+$。

定义2. 给定一个结束时间 $t_{cut}$，双花攻击宣布成功当且仅当存在一个双花攻击实现(DSA)时间 $T_{DSA} \in (0, t_{cut})$ 使得 $\mathcal{G}^{(1)}$ 和 $\mathcal{G}^{(2)}$ 都成立。

对于定义2中的条件，本文将区块生成过程可以看作是随机模型中一个给定区块生成速率为 $\lambda$ 的泊松计数过程。因此，诚实链和欺诈链的长度在时间$t\in(0, \infty]$ 内的增长是两个泊松计数过程，记作 $H(t)$ 的区块生成速率为 $\lambda_H$ 以及 $A(t)$ 的区块生成速率为 $\lambda_A$。初始时间 $t=0$ 时有 $H(0)=A(0)=0$。在一个时间点上，整个系统只能生成一个区块，要么是诚实挖矿者生成要么是攻击者生成。在一个离散时间域中，$H(t)$与$A(t)$的差可以表示一个随机游走过程。
  * 随机过程 $M(t) = H(t)+A(t)$ 是生成率为 $\lambda_T = \lambda_H+\lambda_A$ 的泊松计数过程；
  * 随机过程 $S(t) = H(t)-A(t)$ 连续时间内的类随机游走过程。令 $T_i = \inf\{t\in\mathbb{R}^+, M(t) = i\}$ 是状态发展时间，则 $S_i = S(T_i)$ 是 $T_i$ 时刻诚实链和欺诈链的差。并且随机游走 $S_i$ 是初始 $s_0 = 0$ 的稳定马尔科夫链。状态转换的概率分别为 $p_A = Pr(S_i = n-1|S_{i-1} = n) = \frac{\lambda_A}{\lambda_T}, p_H = Pr(S_i = n+1|S_{i-1} = n) = \frac{\lambda_H}{\lambda_T}$。
  * 因此，可以定义一个独立同分布状态变换随机变量 $\Delta_i = S_i-S_{i-1}\in\{\pm1\}\sim Bernoulli(p_H)$，且 $S_i = \sum_{k=0}^i\Delta_k$

### 双花攻击成功概率和成功攻击时间概率的计算

定义3. 双花攻击$DS(p_A, t_{cut};N_BC)$是一个选取样本$\omega\in\Omega$的随机试验，其中每个$\omega = ((T_1,\Delta_1), (T_2,\Delta_2), \dots, (T_\infty,\Delta_\infty))$，集合$\Omega = \{\omega\in\{\mathbb{R}^+\times\{\pm1\}\}^\infty\}$。对于给定的$DS$样本$\omega$以及状态指标$i$，投影表示$\pi_{T_i}(\omega) = T_i, \pi_{\Delta_i}(\omega) = \Delta_i$。

定义4. 对于$DS(p_A, t_cut;N_BC)$的$DS$样本$\omega$，定义双花攻击实现时间按$T_{DSA}$来测在实现必要条件$\mathcal{G}^(1),\mathcal{G}^{(2)}$的样本$\omega$时的状态指标$i$的最近的状态发展时间$\pi_{T_i}$。

给定双花攻击$DS(p_A, t_{cut};N_BC)$的$DS$样本$\omega$，该样本同时满足双花攻击两个必要条件的概率为$P_{DSA,i} = Pr(\omega\in\mathcal{D}_j^{(1)}\cap\mathcal{D}_{i,j}^{(2)})$。从而可以推导出当双花攻击$DS(p_A, t_{cut};N_BC)$的$t_{cut} = \infty$时的样本$\omega$，双花攻击成功的概率为：
 $\mathbb{P}_{DSA}=\left\{
    \begin{aligned}
    1 &  & \text{if } p_H\leq p_A, \\
    1-p_A^{N_{BC}+1}p_H^{B_{BC}}\sum_{j=N_{BC}}^{2N_{BC}}C_{j-1}^{N_{BC}-1}A_j &  & \text{if }p_H > p_A.
    \end{aligned}
  \right.$
其中$A_j = p_A^{j-2N_{BC}-1} - p_H^{j-2N_{BC}-1}$。

双花攻击的时间$T_{DSA}$的概率密度函数遵循给定状态指标$i$时的$T_i$的密度函数，在$p_{DSA,i}$的概率下满足$\omega\in\mathcal{D}_j^{(1)}\cap\mathcal{D}_{i,j}^{(2)}$。当不存在这样的指标时，概率为$1-\mathbb{P}_{DSA}$，那么$T_{DSA} = \infty$。因此$T_{DSA}$的概率密度函数为$f_{T_{DSA}}(t) = \sum_{i=2N_{BC}-1}^\infty p_{DSA,i}f_{T_i}(t) + (1-\mathbb{P}_{DSA})\delta(t-\infty)$。

一个双花攻击$DS (P_A, t_{cut};N_{BC})$成功的概率为$\mathbb{P}_{AS}(t_{cut}) = Pr(T_{DSA} < t_{cut})$，当$t_{cut} = \infty$时，$\mathbb{P}_{AS}(t_{cut}) = \mathbb{P}_{DSA}$。一个双花攻击成功的时间定义为：
$T_{AS}=\left\{
    \begin{aligned}
    T_{DSA} &  & \text{if } T_{DSA} < t_{cut}, \\
    undefined &  & \text{Otherwise }.
    \end{aligned}
  \right.$

攻击成功时间$T_{AS}$的概率密度函数$f_{AS}$是比例系数为$\mathbb{P}_{AS}^{-1}$的$f_{T_{DSA}}(t)$的扩展，其中$0<t<t_{cut}$。
$f_{T_{AS}}(t)=\left\{
    \begin{aligned}
    f_{T_{DSA}}* \mathbb{P}_{AS}^{-1}&  & \text{for } 0< t < t_{cut}, \\
    0 &  & \text{for }t\geq t_{cut}.
    \end{aligned}
  \right.$
由此得到攻击成功时间的期望为$\mathbb{E}_{T_{AS}}(t_{cut}) = \frac{\int_0^{t_{cut}}tf_{T_{DSA}}(t)dt}{\mathbb{P}_{AS}(t_{cut})}$.

### 双花攻击成功收益的计算

本文定义了双花攻击$DS(C,p_A,t_{cut};N_{BC})$的收益函数为$P$，其中$C$是欺诈交易的价值（用计算能力的收入和运营费用表示）。记$X$是算力的租赁费用，区块的挖矿费用$R$与攻击成功是消耗的算力比例$\lambda_A$和时间$t$相关。定义出收益函数的表示为：
$P=\left\{
    \begin{aligned}
    C+R(\lambda_A, T_{AS})-X(\lambda_A, T_{AS})&  & \text{if } T_{DSA} < t_{cut}, \\
    -X(\lambda_A, T_{AS}) &  & \text{otherwise}.
    \end{aligned}
  \right.$

  由此得到收益的期望为：
  $\mathbb{E}_P = \mathbb{P}_{AS}(t_{cut})\cdot (C + \mathbb{E}[+R(\lambda_A, T_{AS})] - \mathbb{E}[X(\lambda_A, T_{AS})]) - (1- \mathbb{P}_{AS}(t_{cut}))\cdot X(\lambda_A, T_{AS})$。

  根据双花攻击收益的期望，本文给出了双花攻击成功后是否有收益的充要条件：

  定义5：一个双花攻击$DS(C,p_A,t_{cut};N_{BC})$是有收益的当且仅当收益的期望$\mathbb{E}_P > 0$。

通过计算出满足有限时间内双花攻击成功必要条件时的攻击成功概率，可以计算得到在有限时间内攻击成功的收益的期望、成功攻击时间的期望等，通过对这些参数的分析。可以得到双花攻击成功的充要条件，以此来衡量整个区块链系统对于双花攻击的抗性，即系统的安全性。

## 仿真结果

通过理论分析计算得出以下结论：

1. 当攻击者算力小于50%时，攻击者依然是有利可图的，因此对区块链是由威胁的；
2. 通过计算得到双花攻击成功所需要的资源（算力）；
3. 通过计算刷概念化攻击成功所需要的时间的概率分布函数，使得能够计算出攻击者挖矿的时间和费用；
4. 确认区块的数量将极大的影响攻击成功的概率，确认区块数量越少，有利攻击所需要的最小资源越少；

## 最终结论

1. 给定确认区块数量后，将任意交易值设置为小于攻击可获利所需要的值；
2. 给定交易值后，网络以最小确认区块数量使得通知收款人确认从而阻止攻击成功获利。

## 问题讨论

1. 本文主要是理论分析，并没有相关的仿真实验比对结果；
   * 通过在一个实际的区块链系统运行，仿真模拟相应的场景，，通过仿真几个参数对于双花攻击成功概率、双花攻击成功时间以及双花攻击成功收益的期望的实际变化情况与理论分析情况做对比，来验证我们分析的有效性和准确性。
2. 影响双花攻击成功并且获利的主要因素是区块数量、交易价值以及攻击者的算力。但是针对自适应双花攻击，等待区块数量（等待延迟），或者等待交易传输时延（快速支付）以及交易费用的高低应该也是影响双花攻击收益的因素。
  * 在分析双花攻击的收益时，其攻击模型时需要注意的，不同的攻击模型会有不同的收益期望，与此同时，交易区块中交易的数量以及交易费用也是收益中的一部分，也应该考虑进收益期望中。因此收益的期望为：$\mathbb{E}(R_b+R_T+C|p_A,K,m,n,t_{cut}) = P_{sucessful}*(C+\sum_{i=0}^n(R_b^i + R_T^i-C_b^i) + P_{Fail} * (-\sum_{i=0}^nC_b^i)$，在攻击成功后，$K$是目标交易从发出到出现在诚实链上这段时间诚实链的生成区块的数量，$m$是诚实链分支的长度，$n$是欺诈链分支的长度。通过分别对攻击成功时间的期望和收益的期望进行分析计算，我们将知道攻击事件越短，收益越高，系统越不安全，攻击成功事件越长、收益越低则系统越安全。
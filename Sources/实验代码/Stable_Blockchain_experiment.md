# 稳定共识算法实验

## 权重系数 VS 优质节点被选中的概率

在稳定区块链协议中，主要是根据节点的稳定度来随机选举出块节点。新节点加入系统要质押金钱获得有限的活动时间。活动的时长与交付的押金成正比。

记 $T_{v}$ 为无线网络节点 $v$ 在区块链系统中的活跃时间，所有共识节点的剩余活动时间之和为 $\sum_{i \in N}T_{i}$，定义节点的活动时间比为 $\rho_{v} = \frac{T_{v}}{\sum_{i \in N}T_{i}}$。记 $r_{v}=\frac{N_{v}}{K}$ 为节点在最近 $K$ 个确认区块中参与共识比值，其中，$N_{v}$ 是节点 $v$ 生成区块的数量。定义无线网络节点 $v$ 的稳定度为 
$$S_{v}=\alpha\times \rho_{v}+\beta\times r_{v}$$
其中，权重系数 $\alpha, \beta$ 可根据偏好设置。在区块链系统运行初期，确认区块数量不足 $K$ 个时记节点的共识比 $r_{v}=0$，此时节点的稳定度主要受节点的活动时间的影响。

轮盘赌的方式根据节点的稳定度决定节点被选中的概率。记 $S_{i}$ 是节点 $i$（$i=0,\dots,N-1$）的稳定度，所有节点的稳定度之和为 $S =\sum_{i=1}^{N}S_{i}$ ，那么节点 $i$ 被选中的概率为 $p_{i}=\frac{S_{i}}{S}$ 且有 $\sum_{i=1}^{N}p_{i}=1$。为了确定被选中的节点，将区间 $[0, 1)$ 分为连续的多个区间
    $$[\sum_{k=1}^{i}p_{k}, \sum_{k=1}^{i+1}p_{k}),\ i=0,\dots,N-1.$$

每个节点都可以通过相同的输入，最终确定当前轮的首领节点。我们需要分析，当节点存在维护的区块链或者剩余活动存在差异时，是否会导致最终的出块节点的选举出现较大的偏差。

记 $S_{v} = \alpha\times\frac{T_{v}}{\sum_{i \in N}T_{i}} + \beta\times\frac{N_{v}}{K}$，记 $S_{v}' = \alpha\times\frac{T_{v}+ \Delta T_{v}}{\sum_{i \in N}T_{i} + \Delta T_{v}} + \beta\times\frac{N_{v} + \Delta N_{v}}{K}$, 那么 $||S_{v}' - S_{v}|| = ||\alpha\frac{\sum_{i \in N}T_{i}\Delta T_{v} - T_{v}\Delta T_{v}}{\sum_{i \in N}T_{i}(\sum_{i \in N}T_{i}+\Delta T_{v})} + \beta\frac{\Delta N_{v}}{K}||\leq ||\frac{\Delta T_{v} }{\sum_{i \in N}T_{i}+\Delta T_{v}} + \frac{\Delta N_{v}}{K}|| \ll \Omega(1)$

因此，当节点记录的剩余活动时间和共识区块数量存在些许误差时，对于最终稳定性的影响不会太大，节点被选中的概率是对于这两个度量指标的敏感度也不会特别大。因此，诚实节点选中不同出块节点的概率是非常低的。

### 客观权重系数确定的方法

* **均方差法**：$W_{j} = \frac{s_{j}}{\sum_{k = 1}^m s_{k}}$，其中 $W_{j}$ 是指标 $j$ 的权重，$s_{j}$ 是指标 $j$ 的标准差， $m$ 是指标总数。越离散，权重越大，但未考虑均值。
* **变异系数法**：$W_{j} = \frac{v_{j}}{\sum_{k = 1}^m s_{k}}$，其中 $W_{j}$ 是指标 $j$ 的权重，$v_{j} = \frac{s_{j}}{x_{j}}$ 是指标 $j$ 的变异系数，$s_{j}$ 是指标 $j$ 的标准差，$x_{j}$ 是均值，变异系数可用于衡量样本的离散程度，$m$ 是指标总数。越离散，权重越大。
* **独立性权重**（CRITIC 法--Criteria Importance Though Intercrieria Correlation）：$C_{j} = \sigma_{j}\sum_{i = 1}^n (1-r_{ij})$，其中 $C_{j}$ 是指标 $j$ 的权重，$\sigma_{j}$ 是指标 $j$ 的标准差，$r_{ij}$ 是指标 $i, j$ 的相关系数。$W_{j} = \frac{C_{j}}{\sum_{k = 1}^n C_{k}}$ 越独立，权重越大，但未考虑均值。

我们可以采用均方差的方法确定两个指标的权重系数。分别计算活动时间和共识比的均方差。节点在一个区域中的活动时间服从指数分布，节点生成区块的数量服从正态分布。

#### 节点活动时间

设 $X$ 表示节点的活动时间，分布函数 
$$F(t) = P(\leq t) = \int_{0}^{t}dF(t)$$
表示节点时间不超过时间 $t$（即在时刻 $t$ 之前失效）的概率。**概率密度函数**为 $f(t) = \frac{dF(t)}{dt}$，节点活动时间大于 $t$ 的概率为 $R(t) = P(X >t) = 1 - F(t)$，节点的**可靠度**，当 $R(0) = 1, R(\infty) = 0$。节点的**平均活动时间**（即$X$ 的数学期望）为 $EX = \int_{0}^{t} tdF(t) = \int_{0}^{t}tf(t)dt = \int_{\infty}^{t}R(t)dt$。设节点在 $t$ 时刻正常，在 $[t, t + \Delta t]$ 内失效的概率为 $P(X\leq t + \Delta t|X> t) = \frac{P(t< X\leq t + \Delta)}{P(X> t)} = \frac{F(t + \Delta t) - F(t)}{1 - F(t)}\approx \frac{f(t)\Delta t}{R(t)}$，则 $r(t) = \frac{f(t)}{R(t)}$ 是节点的**失效率**。

对于 $N$ 个节点同时参与共识，记 $n(t)$ 为时刻 $t$ 之前失效节点的数量，$\Delta n(t)$ 为之后一个单位时间内失效节点数量，因此有 $r(t) \approx \frac{\Delta n(t)}{N-n(t)}$。假设节点在 $t$ 时刻未失效，在 $[t, t + \Delta t]$ 内失效的概率有 $\lambda \Delta t + o(\Delta t)$ 的形式，与时间 $t$ 无关，$\lambda > 0$。当有 $r(t) = \lambda$ 时有 $\frac{dF(t)}{dt} = \lambda[1 - F(t)]$，由 $F(0) = 0$ 可得到
$$F(t) = 1 - e^{-\lambda t}, t\geq 0, \lambda \geq 0,$$
节点的活动时间 $X$ 服从指数分布，由指数分布的“无记忆性”（或“无后效性”），节点正常运行到时刻 $t$ 后，还能正常运行到时刻 $\tau$，其仍服从指数分布，也就是 $P(X > t + \tau|X > t) = P(X > \tau) = e^{-\lambda\tau}$。因此，节点活动时间的概率密度函数、可靠度、平均时间分别是 $f(t) = \lambda e^{-\lambda t}, R(t) =  e^{-\lambda t}, EX = \frac{1}{\lambda}$，方差为 $D(X) = E(X^{2} - [EX]^2 = \frac{1}{\lambda^{2}}$, 标准差为 $\frac{1}{\lambda}$。假设节点在 $K$ 个区块中生成区块的数量服从标准差为 $1$ 的正态分布。

根据均方差确定权重的方法，节点活动时间的标准差为 $\frac{1}{\lambda}\approx\frac{N-n(t)}{\Delta n(t)} = N$， 节点生成区块的数量的标准差为 $1$，因此 $\alpha = \frac{N}{N+1}, \beta = \frac{1}{N+1}$。因此，我们的实验中，节点活动时间的权重系数尽可能大于节点共识比的系数，这样更能够确保选举到比较优质的节点成为首领。

## 区块大小VS 共识时延和吞吐量

* 区块的**共识时延**定义为区块产生到最终链接到区块的时间（区块确认时间）；
* 区块链的**吞吐量**定义为单位时间内处理交易（最终上链交易）的数量。

区块的共识时延主要是区块传输和确认产生的时延。区块的大小会影响区块在网络中的传输时延。设区块大小为 $S_{block}(MB)$，网络中带宽为 $B(bps)$，广播时传输时延为 

$$T_{transmission} = \frac{S_{block} * 2^{20} * 8}{B}$$
因此，当区块越大，节点传输时延越大，最终会提升区块的共识时延。

假设区块中交易的最大数量为 $num_{transactions}$，确认区块的共识时延为 $T_{consensus}$。吞吐量 

$$TPS = \frac{num_{transactions}}{T_{consensus}}$$

如果信道带宽足够大，即使区块增加也不会明显影响区块的共识时延时，增加区块的大小可以明显提升系统的交易吞吐量。

通过固定网络带宽时，测试不同区块大小对共识时延和交易吞吐量的影响。

## 签名数量 VS 共识时延和吞吐量

稳定共识协议中，区块的确认需要足够数量的签名，因此签名消息在网络中的传输会极大的影响区块的共识时延。当节点数量和网络带宽固定时，测试不同签名阈值时得分共识时延和吞吐量情况，分析签名数量对于协议性能的影响。

## 网络带宽 VS 共识时延和吞吐量

网络带宽主要是系统中数据传输的速率，带宽越大，数据传输越快。我们的稳定共识协议需要通信的次数为 $O(2N + \lceil\frac{N}{2}\rceil^2)$。因此带宽将很大程度上影响共识协议的性能。当区块和签名消息的数据大小固定时，网络带宽越大，共识时延会越低，从而吞吐量会越高。

因此，我们可以通过实验测试一下网络带宽在我们的协议中对共识时延和吞吐量的影响。固定区块大小和签名大小，测试不同网络带宽时，区块共识时延和吞吐量的变化情况。

## 消息丢失率 VS 共识时延和吞吐量

无线网络由于链路不稳定，容易出现消息丢失的情况。固定区块大小和网络带宽时，测试不同消息丢失率下系统共识时延和吞吐量的变化情况。进一步分析存在消息丢失时，系统依然能够达成共识的概率。

## 节点的移动速率 VS 共识时延和吞吐量

无线网络中节点具有移动性，可能节点的移速会影响共识协议的性能。测试节点具有不同移动速率时，共识时延和吞吐量的变化情况，分析节点的移动速率对于共识协议性能的影响。

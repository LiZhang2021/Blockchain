# 无线区块链系统

## 一、系统模块设计

本系统以无线节点模块为核心，搭建区块链仿真系统，主要功能有：
* 启动网状的无线网络；
* 实现无线节点之间的通信；
* 实现简化区块链；

### 1.1 系统启动模块

系统启动后，依次执行网络拓扑生成、启动网络、注册节点等操作，确保节点能在网络中正常通信。

### 1.2 节点模块

节点的主要功能有：
* 生成节点ID、路由表、本地IP、本地区块链等初始化数据结构；
* 提供更新路由表、下载邻居节点的区块链、挖矿等异步方法；
* 保存日志、序列化区块链；
* 处理广播、请求和回复等消息；

### 1.3 RPC发送和处理消息

发送消息：
* 发送请求
* 发送回复
* 发送广播

处理消息：
* 处理普通请求
* 处理回复消息
* 处理广播消息
* 处理超时消息
  
### 1.4 节点子模块

节点中的日志模块和区块链模块
* 日志模块：记录节点的操作等
* 区块链模块：实现生成区块、验证区块、挖矿、挖矿结果证明等方法

## 二、系统中节点启动

### 2.1 创世节点启动

过程：
* 节点启动加入网络后，通过广播消息到预定义的节点后，发现路由表为空
* 节点创建一个区块链
* 节点创建一个新交易
* 节点开始挖矿，将交易打包进创世区块
* 创世节点启动完毕，可以监听各种消息

<font color = red>这个过程可能会有问题，如果加入网络的节点是一个孤立的节点，则可能会创建多条区块链。或者一开始存在多个距离很远的节点，会同时生成多条区块链。因此，设计**安全的系统自启机制**是我们需要解决的问题。</font>

### 2.2 其他节点启动

一般过程：
* 节点发送请求路由表消息，获取路由表信息
* 节点向邻居节点发送拉取区块链的消息，对收到的区块链进行长度的比较，保留最长的链，并序列化到本地
* 节点新建交易，并广播给邻居节点
* 节点开启新线程，执行挖矿逻辑。或者节点通过广播的方式同志其他节点在新一轮区块生成过程中愿意提供服务的活动时间（与稳定度相关）
* 启动事件监听和相应操作

## 三、共识算法的设计与实现

本实验对基于节点稳定性的共识算法进行建议模拟，稳定度高的节点有更大概率获得出块权限，然后获得奖励，主要模拟流程如下：
* 所有节点启动完毕之后，新开一个线程，执行出块节点选举逻辑；
* 每个节点向其他节点广播其当前的稳定度（或者是当前愿意提供服务的活动时间）；
* 当所有节点都收到来自其他节点的稳定度（活动时间）广播后，使用相同的随机种子作VRF函数的输入，查看自己是否获得出块权限；
* 一旦某个节点确定自己当选为出块节点后将生成区块，从未处理交易池中拉取交易，验证后放入区块中，该节点将新的区块广播；
* 某一个节点一旦接收到某个新区块后，验证该新区块：
  * 如果验证区块有效且出块节点有效后，则发送确认区块签名份额；
  * 如果验证不通过，则不发送确认区块签名；
* 当节点收集到的相同的区块的确认签名份额达到阈值之后，组合得到区块的最新签名则将区块存入本地区块链并广播；
* 某个节点接收到某个区块的最终签名后，将该区块添加到自己的本地链上；
* 继续新一轮生成下一个区块。

基于节点稳定性的共识算法根据节点的稳定性来确定出块节点，并且其他节点可以快速验证出块节点的有效性，降低了生成区块所需要消耗的算力。通过组合签名的方式可以快速确认区块，提高交易的处理效率。

### 3.1 数据结构设计

交易的数据结构包括发送者、接收者、交易金额
* 交易的ID：TransID
* 交易发起方：Payer
* 交易收款方：Receiver
* 交易金额：count

区块的数据结构包括区块头和区块体：
* 区块头：
  * 版本号：Version
  * 区块索引：Index(即区块高度)
  * 父块哈希：PreviousHash
  * 时间戳：TimeStamp
  * 默克尔根：MerkelRoot
  * 区块哈希：Hash
  * 区块生成节点ID: NodeID
* 区块体：
  * 交易数量：numTransactions
  * 交易数据：Transactions

区块链数据结构包括
* 区块链: chain
* 当前处理的交易：current_Trans
* 当前维护区块链的节点集合：node_set
* 区块链所属节点的ID：NodeID

节点的数据结构包括
* 节点ID：NodeID
* 节点的活动时间：ActiveTime
* 节点的路由表：RoutingTable
* 区块链：Blockchain
* 节点本地地址：local_addr
* 节点的位置信息：location
* 节点请求函数:recall_Fuction
* 节点广播:broadcast

### 3.2 函数功能模块

* 区块链模块:
  * 生成区块：
  * 注册节点：
  * 生成交易：
  * 计算区块的哈希：
  * 获取区块链最后一个区块：
  * 稳定性证明函数：
  * 有效证明函数：
  * 检查区块链是否分叉：
  * 检查交易:
  * 删除本地为处理交易池中已经在区块链上的交易。
  <font color = red>还需要实现一个钱包功能，交易模型采用UTXO模型</font>

* 区块链网络模块：
  * 搭建具有网状拓扑结构或者树状拓扑结构的网络：可以使用Mininet搭建一个网络拓扑，可以限制链路带宽来测试网络时延和交易处理效率等（需要学习Mininet Python相关知识，学习怎么搭建网络）；
  * 基于异步的节点通信协议：（学习Soket编程相关的知识）
    * 发送消息：
      * 建立链接：
      * 断开连接：
      * 发送广播消息：
      * 发送请求消息：
      * 发送回复消息：
    * 处理消息：
      * 收到数据后调用函数：
      * 处理请求消息：
      * 处理回复消息：
      * 处理广播消息：
      * 处理超时消息：
      * 发现错误后调用函数：
  * 建立网络节点的路由表：
    * 路由表数据结构：节点ID、记录所有的路由节点
    * 根据节点的位置信息添加Peer节点到表
    * 通过节点的ID获取节点
    * 通过节点的IP获取节点
    * 通过节点的IP获取节点的ID
    * 获取邻居节点
  * 节点功能模块：
    * 设置本地地址
    * 查找节点
    * 记录交易
    * 记录新区块
    * 下载节点区块链
    * 更新路由表
    * 加入系统
    * 解决冲突（当出现分叉链时，从邻居处获取最长的有效链）
    * 执行基于稳定性的共识协议
    * 创建交易
    * 创建区块
    * 记录本地信息
    * 记录交易信息
    * 记录区块信息
    * 处理接收的消息
    * 监听命令

实验内容

【实验一】：无线网络仿真
* 搭建一个全连通的网状无线区块链网络
* 节点之间进行通信
* 节点之间通过网络传输交易、区块、消息等数据

【实验二】：区块链系统仿真
* 实现区块链网络的仿真
* 模拟网络交易和区块的生成以及传播逻辑
* 实现基于稳定性的共识算法
* 测试不同节点数量下，区块确认时延、交易吞吐量情况
* 测试不同节点密度下，区块确认时延、交易吞吐量情况
  
### 3.2 需要补充的技术知识

* 如何实现多个节点同时挖矿（需要学习多线程相关的知识）
* 无线网络节点之间通信协议相关的知识（了解无线网络的通信过程和特征，也许需要嘘唏Socket编程）
* 无线节点之间通过路由表进行通信，每个节点的路由表



# 无线区块链系统中的共识算法实验（[论文](./../Blockchain_in_Wireless_Networks/papers/Wireless_Algorithms_Systems_And_Applications_p568(D.Yu&etal,%20Book,%202020).pdf)）

【描述：（一）实验目标，（二）实验方案（详细的实验方案，包括实验环境、实验步骤等），（三）技术难点（目前的技术难点、还需要补充的知识等）。】

## 一、实验目标

测试在单跳无线区块链系统中，基于无线通信的共识算法的性能。在一个固定大小的矩形网络区域中随机均匀分布一定数量的无线节点，测试不同当选首领节点数量下达成共识所需的共识时长和共识错误率。

## 二、实验方案

### 2.1 仿真内容

* **无线区块链网络仿真**：
  * 搭建一个全连接的无线节点构成的网络；
  * 不考虑交易广播、打包区块等情况，只考虑节点之间达成共识的消息通信；
  * 节点存在四个状态：挖矿状态、跟随者状态、候选者状态和首领状态；
  * 系统中的所有操作都是按轮进行的；
  * 根据无线节点的接收的信号强度和信噪比的大小来确定节点的状态，并采取相应的操作（监听或者传输）；
  * 设置无线节点具有相同的传输概率和不同传输功率。
  
* **区块链共识算法仿真**：

仿真实现采用通信证明（PoC）共识算法达成无线区块链系统共识。
  * **初始化系统**：所有节点初始状态都是挖矿状态，通信竞争首领计数为零；
  * **出块节点选举**：节点通过广播消息来竞争出块权限。节点传输消息时，接收消息的节点将推出竞争。当节点的成功竞争计数超过 $k\cdot \log N$ 后，该节点当选为出块节点。
  * **区块生成**：当选的出块节点会广播区块（包括区块信息、位置信息、传输功率）到区块链网络。位置信息和传输功率是为了让接收节点通过计算接收信号强度来判定区块链网络中是否只有一个首领节点当选；
  * **区块验证**：接收节点一旦发现当前的区块是无效或者区块链网络中首领节点不唯一，就会传输新的区块消息。首领节点根据信号强度决定是否接受新的区块。
  * 区块链更新：若存在多个首领节点或者新区块无效，首领节点会传输新的消息丢弃无效区块；同时沉默节点将会根据首领节点的决定丢弃无效区块。否则，所有节点会将新区块写入其本地区块链中，并转换为挖矿状态，开始新一轮挖矿。

### 2.2 仿真方案

* **【方案一】**：在一个大小为 $100m\times 100m$ 网络区域中均匀的部署 $N = 10, 100, 1000$ 个节点，节点之间的最小距离为，节点的通信半径为 $R = 200m$。节点具有相同的传输概率，采用随机的方式给节点赋予不同的传输功率，初始状态都设为挖矿状态。随后根据无线通信的特征，开始共识过程。通过设计一个通信**选举出块节点的阈值**以高概率确保只有一个出块节点当选，测量**出块节点选举所需要运行的轮数**。还需要测试当出现**多个出块节点时，达成共识所需要的轮数**，**测试轮数与候选者数量之间的关系**。记录节点成为出块节点的次数，每个节点成为首领节点的次数的期望以及系统中达成共识的总次数，从而就有 $出错率 = \frac{|节点成为首领的次数-节点成为首领的次数的期望|}{系统中共识总次数}$。
* **【方案二】**：在一个大小为 $100m\times 100m$ 网络区域中均匀的部署 $N = 10, 100, 1000$ 个节点，节点之间的最小距离为 $1m$，每个节点的通信半径为 $R = 200m$。节点具有相同的传输概率，采用随机的方式给节点赋予不同的传输功率，初始状态都设为挖矿状态。随后根据无线通信的特征，开始共识过程。通过通信计数方式以高概率确保只有一个出块节点当选，测量**出块节点选举所需要运行的轮数**。还需要测试当出现**多个出块节点时，达成共识所需要的轮数**，**测试轮数与候选者数量之间的关系**。记录节点成为出块节点的次数，每个节点成为首领节点的次数的期望以及系统中达成共识的总次数，从而就有 $出错率 = \frac{|节点成为首领的次数-节点成为首领的次数的期望|}{系统中共识总次数}$。考虑每个节点具有相同的**交易到达速率**，交易到达之后需要广播给其他节点，节点接收到新交易之后，需要放入其本地为处理交易集合中。选出出块节点后，出块节点会从未处理交易池中抽取交易打包生成区块，并广播区块消息。因此，需要设置交易的大小、区块的大小、以及网络通信的带宽等参数。随后**测试共识效率，区块的确认时延、交易处理效率**等，进一步测量采用PoC共识算法时，无线区块链系统的性能。
* **【方案三】**：在一个大小为 $100m\times 100m$ 网络区域中均匀的部署 $N = 10, 100, 1000$ 个节点，节点之间的最小距离为 $1m$，每个节点的通信半径为 $R = 200m$。节点具有相同的传输概率，采用随机的方式给节点赋予不同的传输功率，初始状态都设为挖矿状态。随后根据接收和发射信号的情况，以及接收的信号强度，确定系统中的共识情况。**通过传输消息计数的方式以高概率确保只有一个出块节点当选，测量出块节点选举所需要运行的轮数**。当确定出块节点唯一之后，首领节点**收集这段时期内的交易**（假设每个节点具有相同的交易到达率，根据选举出块节点的时长可知大概的交易的数量）。出块节点收集到近期的新交易之后，打包生成区块并广播区块消息到区块链网络。**测试出块节点收集交易所需的时隙长度。**设置交易的大小、区块的大小、以及网络通信的带宽等参数。随后**测试共识效率，区块的确认时延、交易处理效率**等，进一步测量采用PoC共识算法时，无线区块链系统的性能。

### 2.3 系统设计

#### 2.3.1 节点设计

节点的主要功能有：
* 记录节点信息：包括ID、网络节点信息表、位置、本地区块链等；
* 节点自启：获取和更新网络节点信息表，向邻居节点发送拉取区块链的消息，对收到的区块链进行长度的比较，保留最长的链，并序列化到本地；
* 处理消息：发送消息、接收消息、计算接收信号的强度和信噪比等。

#### 2.3.2 共识算法设计

共识算法模拟流程如下：
* 挖矿过程：所有共识节点启动完毕之后，新开一个线程，执行挖矿逻辑（选举出块节点）；
* 生成区块：某个节点获取出块权限后，从未处理交易池中将交易排序，并打包到生成的区块中；
* 广播区块：节点将区块广播后，监听信道若没有多个首领节点，则更新区块链，开始新一轮共识；否则，重新发送新的区块；
* 验证区块：节点接收到区块后，验证区块的有限性。若是有效，则更新区块链；否则丢弃当前区块；
* 开启新一轮的共识。

#### 2.3.3 参数设置

* **节点数量**：$N = 100， 1000， 10000$个节点，节点的位置信息就是节点在网络区域中的坐标；
* **网络区域**：$100m\times 100m$，节点之间的最小距离为$1m$， 节点的通信半径设置为 $200m$；
* **环境噪声**：设置环境噪声(高斯噪声等)上界为 $\mathcal{N} = 1$，路径衰弱指数 $\alpha = 3$，信噪比的 $\beta  = 1.5$
* **传输参数设置**：节点的传输概率为 $p_v = 0.2$，节点的传输功率为 $P_v \in [(100\sqrt{2})^\alpha *\beta\mathcal{N}, 200^\alpha * \beta\mathcal{N}]$是从一个区间中随机选择，确保任何一对节点都可以在无线网络中相互接收消息；
* **接收信号计算**：节点在每一轮需要计算接收的来自其他节点的信号强度和信噪比，$S_v = \sum_{u\in S} P_u\cdot d(u,v)^{-\alpha} + \mathcal{N}, SINR(w,v) = \frac{P_w\cdot d(w,v)^{-\alpha}}{\sum_{w\in S\setminus\{u\}} P_w\cdot d(w,v)^{-\alpha} + \mathcal{N}}$
* **节点状态**：挖矿状态(M)、首领状态(L)、候选者状态(C)和跟随者状态(F)。

### 系统模块设计


## 三、代码设计

### 3.1 节点数据结构

无线节点的数据结构如下：
* 节点ID：NodeID
* 节点信息表：NodesTable
* 节点的经度位置：Node.horizontal
* 节点的纬度位置：Node.vertical
* 节点的传输概率：Node.TProb
* 节点的传输功率：Node.TPower
* 节点的状态：Node.state
* 节点的传输半径：Node.Radius

节点需要实现的功能：
* 节点生成交易
* 节点发送消息
* 节点接收消息
* 节点更新节点信息表
* 打包交易
* 生成区块
* 节点将区块写入本地区块链中

### 3.2 交易数据结构

交易是由资金发送方和资金接收方发起的金额转移产生的记录。因此交易主要由三部分组成：资金发起方、资金收款方和资金金额。
* 交易发起方：Payer
* 交易收款方：Receiver
* 交易金额：count

### 3.3 区块数据结构

区块主要用于打包存储交易，区块包含两部分：区块头和区块体。
* 区块头：
  * 版本号：Version
  * 区块索引：Index(即区块高度)
  * 父块哈希：PreviousHash
  * 时间戳：TimeStamp
  * 默克尔根：MerkelRoot
  * 区块哈希：Hash

* 区块体：
  * 交易数量：numTransactions
  * 交易数据：Transactions

### 3.4 共识算法


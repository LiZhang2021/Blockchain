# 基于节点稳定度的区块链共识算法

## 1. 模型假设

【简单描述：（一）区块链模型，包括节点之间的网络结构和特征、区块结构、存储结构等，例如，节点通信模型（节点拓扑或路由结构、信噪比模型等）、区块链存储模型（链式、DAG、…）等；（二）区块生成过程，包括交易打包、区块生成（包括共识）、区块上链等过程；（三）其它，包括其它与本论文紧密相关的部分。注意：重点剖析与本论文紧密相关的部分。】

### 1.1 区块链模型

在无线自组织网络环境中，链式存储的区块链。

* **网络模型**：考虑一个无线自组织网络，$N$ 个节点随意部署在一个二维平面中。记 $d(u, v)$ 为两个节点之间的欧氏距离，$DR(v)$ 为以节点 $v$ 为中心，通信半径为 $R$ 的圆盘。每个节点都拥有唯一的ID。假设节点可以在网络区域中随意移动，并且节点可以随意进入和离开这个区域。

* **区块结构**：每个节点局部地维护一个区块链。各区块通过引用前一个区块的哈希最终形成一条链的形式。每个区块中包含多个交易、自身区块的哈希、前一个区块的哈希、时间戳、区块的组合签名、区块的高度等信息。假设节点可以被公钥基础设施支持，并且系统中采用的密码学原语是安全的，因此没有恶意实体可以伪造消息。

* **干扰和SINR模型**：采用信号干扰模型能够很好的捕获无线网络的干扰。标准信号干扰的信噪比模型为 
$$SINR(u, v)=\frac{S}{I+N}\geq\beta$$
其中，$S=P\cdot d(u, v)^{-\alpha}$ 是节点 $v$ 接收到的节点 $u$ 的信号的功率，$P$ 是平均信号发射功率，在节点 $v$ 处的干扰为
$$I=\sum_{w\in W∖u}P\cdot d(w, v)^{-\alpha}$$
其中，$W$ 是在当前传输节点的集合，$N$ 为环境噪声，路径损耗指数为 $\alpha\in(2, 6]$，阈值 $\beta>1$ 取决于节点的硬件。假设节点可以进行物理载波监听。

### 1.2 区块生成过程

* **交易的提交和广播**：每个节点产生新交易后广播到网络。节点接收到新的交易后验证交易的合法性，验证成功后放入本地未处理交易池中。

* **出块节点选举**：节点的稳定度决定了节点被选中成为出块节点的概率，采用随机抽签的方式确定系统中的出块节点。

* **区块生成**：当节点获得出块权限之后，会从交易池中取出交易排序并打包到区块，最后广播区块到网络。

* **区块确认和上链**：接收到区块的节点验证区块和出块节点的合法性成功后则发送签名份额到出块节点。当出块节点收集的签名份额达到阈值后，会形成一个最终签名，出块节点会广播最终签名到网络。此时，区块被确认并添加到各节点的本地链上。

### 1.3 其它


## 2. 研究问题

【从技术层面描述：各个问题产生的背景和原因，针对每个问题分别给出若干个可能可行的方案。重点描述“研究问题”产生的原因和进行研究的必要性，对问题分析得越清晰、透彻，越有利于后面的研究；对方案只需进行简单描述，在下一节中再详细描述研究方案。】

在无线自组织网络中，单出块节点共识算法无法确保所有的节点同时维护相同的区块链。出块节点的选择也面临着比较大的资源消耗，对代币依赖、高带宽要求等问题。这些区块链共识算法并不适用于设备资源有限、节点具有高动态性和节点可以随时离开网络的无线多跳网络环境中，因此需要设计一个适用于无线多跳网络环境的单出块节点区块链共识算法。

* **资源消耗**：原因？【出块节点选取时需做工作量证明的计算，因此消耗大量算力】方案？【用一种替代工作量证明的、对算力要求相对较低的首领选择方式；降低节点的挖矿难度减少工作量证明的消耗；采用不消耗或者较小消耗计算资源的、新的出块节点选举方式】

* **网络拓扑动态变化**：原因？【节点可以在网络区域中随意移动，使得网络拓扑变化大且不可预测，因此节点可能会突然离开系统影响共识过程】方案？【将节点的稳定度作为首领选举的依据，确保选举的首领节点稳定性高，短期内不会离开系统；将节点到其他节点的跳数或者节点的位置作为首领选举的依据，确保首领节点能够尽快将结果发送给其他节点，快速地达成共识；】


## 3. 研究方案

【详细描述“研究问题”中各方案的关键技术方案或算法，包括：方案或算法的细节、重点和难点、该技术方案解决“研究问题”中的哪个问题等。】

### 3.1 定义稳定度

区块链系统中，新节点加入后要质押金钱获得在系统中活动的时间。活动的时长与交付的押金成正比。

记 $T_{v}$ 为无线网络节点 $v$ 在区块链系统中的活跃时间，记 $r_{v}=\frac{N_{v}}{K}$ 为节点在最近 $K$ 个确认区块中参与共识比值，其中，$N_{v}$ 是节点 $v$ 生成区块的数量。定义无线网络节点 $v$ 的稳定度为 
$$S_{v}=\alpha\times T_{v}+\beta\times r_{v}$$
其中，权重系数 $\alpha, \beta$ 可根据偏好设置。在区块链系统运行初期，确认区块数量不足 $K$ 个时记节点的共识比 $r_{v}=0$，此时节点的稳定度主要受节点的活动时间的影响。

<font color=red>**重点**：</font>
计算节点的剩余活动时间、节点的共识比和这两个度量的权重系数。

<font color=red>**难点**：</font>
计算影响节点稳定度的度量的权重系数，测量节点的共识比，计算其他节点的稳定度，验证首领节点的合法性。

<font color=red>**解决的问题**：</font>
解决工作量证明选取出块节点消耗巨大算力，解决出块节点突然离开系统导致最终无法达成共识的问题，防止女巫攻击。

### 3.2 共识算法

区块链系统需要共识算法确保所有节点维护相同的区块链。共识算法主要分为几部分：出块节点的选举、区块共识过程和区块确认。我们将根据节点的稳定度随机选举出块节点。稳定度高的节点具有更大的概率被选中，稳定度低的节点被选中的概率将更小。区块的确认则是采用多方签名方式得到大部分节点的认可后区块就被确认。

* **随机选举出块节点**：采用随机的方式选举出块节点需要满足几点：一是选择的概率与节点的稳定度相关且必须是随机的，二是随机选择是唯一的，三是随机计算的结果必须可以被其他节点验证。首领选举采用随机可验证函数，将上一个区块的哈希和最终签名作为随机种子计算得到结果和证明，其他节点可以根据证明验证该节点的合法性。

    * **轮盘赌抽签**
    轮盘赌的方式根据节点的稳定度决定节点被选中的概率。记 $w_{i}$ 是节点 $i$（$i=1,\dots,N$）的稳定度，所有节点的稳定度之和为 $W=\sum_{i=1}^{N}w_{i}$ ，那么节点 $i$ 被选中的概率为 $p_{i}=\frac{w_{i}}{W}$ 且有 $\sum_{i=1}^{N}p_{i}=1$。为了确定被选中的节点，将区间 $[0, 1]$ 分为连续的多个区间
    $$[0, p_{1}],\ (\sum_{k=1}^{i-1}p_{k}, \sum_{k=1}^{i}p_{k}],\ i=2,\dots,N.$$
    随机可验证函数将区块的哈希和最终签名作为输入计算得到一个值和证明
    $$(value, proof)=VRF(sk, Block||Signature_{group})$$
    若 $\frac{value}{2^{bits(value)}}$ 落在某个节点所属的区间之内，则该节点被选举为出块节点。

	* **验证抽签结果**
    根据随机可验证函数输出的值和证明，其他节点也可以验证出块节点选举结果的合法性。
    $$result=VerifyVRF(pk, value, proof, Block, Signature_{group})$$
    如果验证结果为 $result= 1$，则出块节点的验证成功，该节点是合法的；如果结果为 $result= 0$，则出块节点的合法性将不被承认。

* **区块共识过程**：出块节点将交易排序并打包成区块，随后广播到网络。其他节点验证区块和出块节点的合法性后，会发送签名份额给出块节点。

* **区块确认**：当出块节点收集到的签名份额达到阈值后，会聚合形成一个最终签名。该区块获得了系统中一定数量节点的认可，可以被添加到区块链上。出块节点会将区块添加到本地链并广播最终签名到全网。其他节点接收到最终签名并验证成功后，也会将区块存入本地区块链中。

<font color=red>**重点**：</font>
采用轮盘赌方式选举首领和基于门限签名的方式确认区块。

<font color=red>**难点**：</font>
快速计算每个节点的稳定度和被选中概率，门限签名份额的发送和收集。估计出块节点广播的区块被系统中节点接收到的时延。

<font color=red>**解决的问题**：</font>
解决女巫攻击的和公平性问题，确保每个节点都可能被选中成为出块节点获得奖励。解决无利害关系攻击和长程攻击问题，门限签名机制确保节点无法在多个分支上同时挖矿，也无法篡改早期已经被确认的区块。
</font>

### 3.3 奖惩机制

* **奖励机制**：当区块被确认后，生成区块的节点将获得部分区块奖励和交易费用，剩余部分的奖励将分发给后一个区块的生成者。这样的奖励机制可以使得诚实节点更愿意在新区块后面挖矿，减小分叉的概率提高安全性。同时也能激励系统中的节点积极维护系统区块链，提升系统的活性。

* **惩罚机制**：如果节点在未到活动时间结束之前离开系统，则会扣除部分押金。当发现有节点作恶后系统也会扣除押金。这个机制会降低节点离线和作恶的机会。

<font color=red>**重点**：</font>
采用奖励机制提高节点的活性和系统的安全性，使用惩罚机制降低节点作恶的动机。

<font color=red>**难点**：</font>
计算奖励分配比例确保节点私自挖矿成功的概率非常低。

<font color=red>**解决的问题**：</font>
解决节点缺乏活性问题，奖励机制可以激励节点积极地参与共识维护区块链。解决节点长期离线的问题，节点如果长期离线就会蒙受经济损失。


## 4. 仿真实验

【描述：（一）实验目标，（二）实验方案（详细的实验方案，包括实验环境、实验步骤等），（三）技术难点（目前的技术难点、还需要补充的知识等）。】

### 4.1 实验目标

通过仿真实验测试分析采用基于稳定度的共识算法的区块系统的性能，即交易吞吐量和区块确认延时。

* **交易吞吐量**：单位时间内处理交易的数量；

* **区块确认延时**：区块确认的平均时延。

在仿真实验中需要测试不同区块大小、节点数量、节点密度的情况下区块链系统的交易吞吐量和区块确认延时。

考虑网络带宽，网络通信协议、单位时隙大小、编程语言、运行设备、测试次数等。

影响因素包括：区块大小、网络大小、节点密度等。

### 4.2 实验方案

【如何来完成实验？在自己设计的区块链中采集数据进行分析？在公链上进行实验？实验步骤是什么？】

由于需要在无线自组织网络中测试区块链系统的性能，因此需要仿真无线区块链系统进行数据采集和分析。实验步骤如下：

* **搭建无线自组织网络**：每个节点都以相同的移动速率在网络区域中随机运动，且在区域中的活动时间是有限的。一旦节点活动时间结束该节点就不能参与共识维护区块链。新节点加入系统后，会广播自身信息，获取其他网络节点信息和同步系统中的区块链。对于节点之间的通信采用CSMA/CA作为通信协议。

* **记录节点的活动时间**：为每个节点赋予不同的活动时间，当活动时间结束则该节点离开网络。记录节点进入网络的时间。

* **生成交易**：构造一批不同的交易，确保他们的哈希不同。发送交易到网络中，并记录开始发送交易的时间

* **生成区块**：从参与共识的节点中选举出块节点，随后生成区块并发送到网络中，记录区块发送时间。

* **确认区块**：查看节点的日志中区块确认的时间并记录。同时还需要计算区块中交易的数量。

* **计算区块确认延时**：计算区块生成时间和确认时间可以得出区块的确认延时。

* **计算交易吞吐量**：计算一个区块中处理交易的数量，除以区块的确认时延，可以得到平均交易吞吐量。

### 4.3 技术难点

【根据设计的实验方案，目前的技术难点或需要学习的知识有哪些？】

* <font color=red>**技术难点**：</font>
  在无线自组织网络上搭建区块链系统，计算稳定度依据的权重系数，获取其他节点的稳定度。获取节点活动起止时间记录，区块发送和确认时间记录，区块中交易数量计数。

* <font color=red>**待学习的知识**：</font>
  仿真实验的实验过程、公链测试共识算法性能的方式
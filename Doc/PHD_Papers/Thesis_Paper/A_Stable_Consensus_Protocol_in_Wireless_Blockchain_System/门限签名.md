# 门限签名

普通区块链交易或者其他签名类如证书等，基本上使用的都是单签名模式，即一个密钥签署一个交易，签名者的数量是单数，多签指的是签名者多于一人。

多重签名机制可以实现多方共同管理资产，也可以用于第三方交易担保，多重签名支持多方共同管理一个地址的资产。 广义来说，任何涉及多方管理和决策的场景都可以使用多签名，类似于投票表决等，来表达对一个事务的观点或意见等。因此，在稳定性共识协议中，我们可以采取多方签名的方式来对区块进行安全的投票表决。

## 1. Schnorr聚合签名

Schnorr聚合签名，有时也称组签名（group signature）， 过程如下：
* 有一组参与签名的公钥，假定是 $N$ 个，签名后会得到 $N$ 个签名，这个 $N$ 个签名是可以相加的，最终得到一个签名。这个签名的验证通过，则代表 $N$ 把公钥的签名全部验证通过，换句话说，就是把多个签名聚合成一个签名。

## 2. BLS门限签名

基于BLS签名的门限签名采用了基于双线性映射的椭圆曲线配对技术来实现签名的验证和聚合。

### 2.1. BLS数字签名原理

BLS字母代表Boneh–Lynn–Shacham，最初是由斯坦福大学教授Dan Boneh等人于2001年提出的一种签名方案，最新是在2018年，Boneh教授与IBM研究机构的Manu Drijvers等人更新了这种签名方案。

2003 年 Boneh 和 Franklin 提出了身份基加密( Boneh D, Franklin M. Identity based encryption from the Weil pairing[J]. Siam Journal on Computing, 2003, 32(3):213-229.)，从此基于双线性映射(也称为 pairing 运算/对运算)的密码学算法走向了人们的视野，并且成为密码学新兴的研究方向。 BLS 签名算法(Dan B, Lynn B, Shacham H. Short Signatures from the Weil Pairing[C]// International Conference on the Theory and Application of Cryptology and Information Security. Springer, Berlin, Heidelberg, 2001:514-532.)就是基于双线性映射构造的，在给出具体的签名算法之前，我们需要学习一下什么是双线性映射。

### 2.1.1 双线性映射

* **群**：设 $G$ 是定义了一个二元运算 $+$ 的集合，如果这个运算满足下列性质：
  * **封闭性**——如果 $a, b\in G$，则 $a+b \in G$。
  * **结合律**——对于任意元素 $a, b, c\in G$，都有 $(a+b)+c=a+(b+c)$ 成立。
  * **单位元**——存在元素 $e\in G$，对于任意元素 $a\in G$，都有 $ a+e = e+a = a$ 成立。
  * **逆元**——对于任意元素 $a\in G$，都存在元素 $a'\in G$，使得 $a + a' = a' + a = e$ 成立。
  $G$ 就叫作一个**群**，记为 $(G，+)$。如果这里的运算 + 是加法运算，则称 $G$ 为**加法群**；如果这里的运算 + 是乘法运算，则称 $G$ 为**乘法群**。如果一个群中的元素是有限的，则称这个群是一个**有限群**；否则称这个群是一个**无限群**。有限群中元素的个数称为**群的阶**。如果群 $(G，+)$ 中的运算 + 还满足交换律，即对 $\forall a, b\in G$，都有 $a+b = b+a$ 成立，则称 $G$ 为一个**交换群**或**Abel群**。
* **循环群**：若群 $G$ 中所有元素都是 $a$ 的幂 $a^{k}$，则群 $G$ 是循环群，$a$ 是群 $G$ 的生成元，若群 $G$ 的阶为素数，则 G 中每一个非单位元元素都是**生成元**。群元素的个数称为阶。二元运算为模乘法的循环群，称为乘法循环群。
* **双线性映射**：设群 $G1,G2,GT$ 是阶为素数 $p$ 的乘法循环群，如果映射 $e: G1 \times G2\rightarrow GT$ 满足以下性质，就称映射 $e$ 为双线性映射:
  * **双线性**:任意元素 $u \in G1，v\in G2$，任意元素 $a,b\in Z_p$($Z_p$ 指的是 $\{0,1,...,p-1\}$),都有 $e(ua,vb) = e(u,v)ab$；
  * **非退化性**:存在元素 $m, n\in G1$ 使得 $e(m,n)\neq 1_{G2}$；
  * **可计算性**:任意元素 $u,v\in G1$ ，存在有效算法计算 $e(u,v)$
    则 $e$ 是一个双线性映射。双线性映射可以通过有限域上的超椭圆曲线来构造。

### 2.1.2. BLS签名过程

* **初始化**：$G1, G2$ 是阶为 $p$ 的循环群，且生成元分别是 $g1, g2$。记 $e: G1 \times G2\rightarrow GT$ 是双线性映射， $h:\{0, 1\}^{*}\rightarrow G1$ 是一个安全Hash函数，公开参数为 $(G1, G2, GT, e, g1, g2, p, h)$；
* **密钥生成**：选择一个随机数 $x\in Z_{p}$ 作为私钥 $pri_{key}$，计算得到公钥 $pub_{key} = pri_{key}\times G$，对要签名的消息做Hash确保消息的完整性 $digest = h(msg)$。
* **签名**：通过私钥对消息签名，将消息摘要点乘私钥得到签名 $signature = pri_{key}\times digest$。
* **验证**：同样将消息做一次Hash得到 $digest' = h(msg)$，检验 $e(pub_{key},digest') = e(pri_{key}\times G, digest') =e(G, pri_{key}\times digest') = e(G,signature') = e(G, signature)$。主要是根据**曲线配对函数**。

# 2.1.3 BLS聚合签名

对于区块链应用场景中，假设对生成区块进行确认需要多个参与者对区块的Hash值进行签名。假设区块Hash值 $hash_{block}$ 是要签名的消息。现在有 $S_{i}, i = 1, \cdots, n$ 个签名和对应的公钥 $P_{i}, i = 1, \cdots, n$。聚合签名是将所有对于区块Hash值 $hash_{block}$ 的签名打包程一个签名，同时验证所有签名的正确性。

记最终签名的结果为 $S = \sum_{i = 1}^{t} S_{i}, i\leq n$。要验证所有签名的正确性，需要检查以下共识是否成立：$e(S, G) =e(\sum_{i = 1}^{t} S_{i}, G) = e(S_{1}, G)*\cdots, *e(S_{t}, G) = e(pri_{key}^1 * hash_{block}, G)*\cdots, *e(pri_{key}^t * hash_{block}, G) = e(hash_{block}, pri_{key}^1 * G)*\cdots, *e( hash_{block}, pri_{key}^t * G) = e(hash_{block}, P_{1})*\cdots * e(hash_{block}, P_{t})$。这里依然使用了配对函数性质，仍需用到所有的公钥，并计算 $t$ 次配对函数。





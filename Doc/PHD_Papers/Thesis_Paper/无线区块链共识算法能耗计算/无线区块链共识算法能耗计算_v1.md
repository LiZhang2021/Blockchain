# 无线区块链共识算法能耗分析

## 区块链性能指标

区块链的性能指标有很多，其中安全边界(security bound)、节点可扩展性(node scalability)、交易吞吐量(transaction )和时延(latency)是分析系统性能比较重要的指标。
* **安全边界**：安全边界与敌手模型密切相关。安全边界是指为确保系统安全性限制的敌手能够掌握的算力或财产占比边界。一般用 $f$ 代表系统允许的最大敌手数量，$n$ 代表网络中节点总数，则安全边界计算公式为：$安全边界 = \frac{f}{n}$。
* **节点可扩展性**：这个指标是用于衡量系统处理不断增加的节点数量的能力。通常基于竞争的共识算法相较于基于协同的共识算法都具有比较好的节点可扩展性。在基于竞争的共识算法中，所有交易和共识结果都需要所有节点广播和接收，当无线区块链网络比较大时的频谱需求是难以负担的。基于协同的共识算法依赖节点之间的大量通信。共识所需的通信资源会随着节点的增加而快速增加，导致效率低和可扩展性差。
* **交易吞吐量和时延**：这两个指标是区块链的重要度量指标，并且存在一定的关联。交易吞吐量是通过每秒的交易数量(Transactions per seconds)来度量的；交易时延是交易从请求到确认所需的时间。一般而言，基于竞争的共识算法由于时间保护特性，通常吞吐量都比较低；而基于协同的共识算法活性较高且快速计算出共识结果，拥有更好的吞吐量。竞争类共识Bitcoin(7TPS, 60mins)和 Ethereum(20~30TPS, 3mins);协同类共识算法(100~1000TPS，受限于当前的物理通信限制)，通信吞吐量是交易吞吐量和时延的瓶颈（实现共识需要大量的消息交换，取决于共识网络中节点的数量）。

## 网络模型和共识流程

假设无线网络中共有 $N$ 各诚实的节点，随机分布在一定一跳通信范围内，即任意两个节点都是消息可达的。节点通过无线信道传输数据，且数据只发送一次，失败后不再重传。

## 节点传输成功概率计算

在无线网络中，传输失败可能会引起链分叉或者视图更换，从而增加网络的系统开销。在分析具体的开销之前，先对节点广播时的传输成功概率进行分析。

### 考虑噪声对节点接收概率的影响

假设节点服从密度为 $\gamma$ 的二维泊松点过程。随机选择一个节点作为发送节点以其为圆心，接收节点分布在半径为 $R$ 的区域里。记发射节点与接收节点的距离为 $r$，其概率密度函数为 $f(r) = \frac{d(r^2/R^2)}{dr} = \frac{2r}{R}$。设定节点传输信道为瑞利信道，根据无线通信中小尺度衰落特性，接收节点的信噪比为

$$SNR = \frac{S}{N} = \frac{P_u\cdot h\cdot r^{-\alpha}}{N}$$

其中 $P_u$ 是节点 $u$ 的发送功率； $h$ 是代表瑞利衰落中非负的功率增益随机变量，服从指数为1的负指数分布； $\alpha$ 是路径损耗指数；$N$ 是噪声功率，服从高斯分布 $N ∼ CN(0, σ^2)$。记系统的信噪比阈值为 $\beta$，根据泊松过程的性质可得到节点传输的平均成功概率为 

$$P_s = \int_0^R P\{SNR >\beta\}f(r)dr = \int_0^{\sqrt{\frac{N}{\pi\cdot\gamma}}}\exp\{\frac{-N\cdot r^\alpha\cdot \beta}{P_u}\}\cdot\frac{2r\pi\gamma}{N}dr = \frac{2\pi\gamma}{N}\int_0^{\sqrt{\frac{N}{\pi\cdot\gamma}}}\exp\{\frac{-N\cdot r^\alpha\cdot \beta}{P_u}\}rdr$$

这个就是广播时节点成功传输的概率。

### 考虑干扰对节点接收概率的影响

假设节点服从密度为 $\gamma$ 的二维泊松点过程，所有节点都分布在一个半径为 $R$ 的区域里。随机选择发送节点和接收节点分别为 $u,v$，记发送节点到接收节点之间的距离为 $d(u,v)$。信道采用SINR信噪比模型，信噪比为

$$SINR(u, v)=\frac{S}{I+N}\geq\beta$$

其中，$S=P\cdot d(u, v)^{-\alpha}$ 是节点 $v$ 接收到的节点 $u$ 的信号的功率，$P$ 是平均信号发射功率，在节点 $v$ 处的干扰为

$$I=\sum_{w\in W∖u}P\cdot d(w, v)^{-\alpha}$$

其中，$W$ 是在当前传输节点的集合，$N$ 为服从高斯分布的环境噪声，路径损耗指数为 $\alpha\in(2, 6]$，阈值 $\beta$ 取决于节点的硬件。由此 $SINR\geq\beta$ 可以写成 

$$\frac{P_u}{d(u, v)^{\alpha}}\geq\beta(\frac{\sum_{w\in W∖u}P_w}{d(w, v)^{\alpha}} + N).$$

假设最多有一个干扰节点，考虑节点接收信号的两种情况：无干扰的噪声受限系统、有一个干扰的干扰受限系统。
* 无干扰的噪声受限系统：此时 $\sum_{w\in W∖u}P_w = 0$，得到公式 $d(u, v) \leq (\frac{P_u}{\beta})^{\frac{1}{\alpha}}$。节点 $v$ 要接收到来自节点 $u$ 的信号必须落在以节点 $u$ 为圆心和 $(\frac{P_u}{\beta})^{\frac{1}{\alpha}}$为半径的区域中。
* 有一个干扰的干扰受限系统：当干扰非常大时，我们可以忽略噪声对信号的影响，设置 $N = 0$。要使得节点 $v$ 达到SINR阈值，则需要满足公式 $d(w,v) \geq R_J$，即接收节点不能在干扰节点的干扰圈内。干扰圈的中心和半径分别为：
  $$(x_J, y_J) = (\frac{\sigma_Jx_u - x_w}{\sigma_J - 1}, \frac{\sigma_Jy_u - y_w}{\sigma_J - 1})$$,
  $$R_J = \frac{\sqrt{\sigma_J(x_u - x_w)^2 + \sigma_J(y_u - y_w)^2}}{\sigma_J - 1}$$
  
  其中 $\sigma_J = (\frac{\beta P_w}{P_u})^{\frac{2}{\alpha}}$。

记节点 $u$ 的有效传输区域为 $A$，以节点 $u$ 的位置为圆心，以$ R = (\frac{P_u}{\beta})^{\frac{1}{\alpha}}$ 为半径。节点 $w$ 干扰区域的中心和半径分别为：$(x_J, y_J) = (\frac{\sigma_Jx_u - x_w}{\sigma_J - 1}, \frac{\sigma_Jy_u - y_w}{\sigma_J - 1}), R_J = \frac{\sqrt{\sigma_J(x_u - x_w)^2 + \sigma_J(y_u - y_w)^2}}{\sigma_J - 1}$， 记干扰区域为 $A_J$。当干扰区域完全落在节点 $u$ 的传输区域中时，则节点 $u$ 传输的平均成功概率$P_s = \frac{A - A_J}{A}$。但是当干扰区域只是部分落在传输区域中时，就不能直接计算出传输成功率。记节点 $u$ 和干扰节点 $w$ 的中心分别为 $(x_u,y_u)，(x_w, y_w)$，两节点之间的距离记为 $d(u,w)$，记 $D = R_J + d(u,w), \beta\in(0, \infty)$，节点 $u$ 的半径记为 $R$。记 $\theta$ 是两个相交点相对于 $(x_J, y_J)的角度，根据 $\theta$, \beta$ 以及关于接收节点的干扰节点的位置，我们分四种情况讨论节点传输成功的概率：
$$ P_s=\left\{
      \begin{aligned}
      & \frac{A-A_J}{A}, \text{if } D\leq R, \beta\neq 1, \\
      & \frac{A-A_J + S - \Delta_J + sign(sin\theta)\times(S_v - \Delta)}{A}, \text{if } D\in (R, R+2R_J), \beta\in(0,1) \text{ or } D\in (R, 2R_J-R), \beta>1, \\
      & \frac{\arccos\frac{d(w,v)}{2R}}{\pi}, \text{if } d(w,v)\in[0, R] \text{ and } -\frac{d(w,v)}{2\pi R}\sqrt{1 - \frac{d(w,v)^2}{4R^2}}\beta = 1, \\
      & 0, \text{otherwise}.
      \end{aligned}
      \right.$$
其中 $S_v, S$ 分别表示接收节点和发送节点的扇形区域。$\Delta, \Delta_J$ 分别表示两个相交点的三角区和接收节点挥着发送节点圆的中心，sign(x)是一是关于 $x$ 的一个标识函数。当 $\beta = 1$ 时，面积计算使用接收节点和干扰节点之间的中点及其垂直线的交点定义的圆弧段。这部分是包含干扰节点的干扰区域，其大小取决于干扰节点相对于接收的位置。 

## 链分叉概率和视图更换概率

### 竞争类共识算法链分叉概率计算

采用竞争类共识算法的无线区块链系统，节点通过竞争获取出块权限，非常容易出现分叉。

假设系统中有 $N$ 个节点，且其中接二点 $k$竞争成功，并广播区块到其他节点。其中有 $M$ ($M\leq N-1, M= N-1$ 时不分叉)个节点传输成功，这些节点验证区块的有效性后立即放弃当前区块的竞争，开始在新区块中后新区块的竞争；剩下的 $N - M - 1$ 个节点继续竞争当前区块的出块权限。 记传输成功的节点集合为 $S$，传输失败的节点集合为 $F$，两个集合中成功节点集合和失败节点集合先生成区块的概率分别为 $p = \frac{M+1}{N}, q = \frac{N - M - 1}{N}$。根据节点传输成功的概率 $P_s$，计算出链分叉的概率 $P_{fork} = \sum_{M = 0}^{N-2}C_{N-1}^MP_s^M(1 - P_s)^{N - M -1}q = \frac{N-1}{N} (1-P_s)$

### 协同类共识算法视图变化概率计算

采用协同类共识算法的无线区块链，在协同过程中没有接收到足够多来自其他节点的消息时，会发生视图变化，下面我们以PBFT为例。

PBFT算法不发生视图变化更换要满足：预准备阶段成功接收消息的节点数目不少于 $\frac{2}{3}$，准备、确认 2 个阶段中成功接收 $2f$ 以上个节点消息的节点个数超过 $\frac{2}{3}$，因此不发生视图更换的概率为： 
$$P_{\bar{v}} = P\{L_1\geq 2f, L_2\geq 2f + 1, L_3\geq 2f + 1\}$$ 
其中 $L_1, L_2, L_3$分别是三个阶段接收到足够数量消息的节点的个数。根据节点传输成功概率 $P_s$，可以计算得到在预准备阶段准备阶段和确认阶段中单个节点接收到 $2f$ 以上条消息的概率分别为
 $$P_{s2} = \sum_{M_2 = 2f}^{L_1}C_{L_1}^{M_2}P_s^{M_2}(1-P_s)^{L_1 - M_2}$$
  $$P_{s3} = \sum_{M_3 = 2f}^{L_2}C_{L_2}^{M_3}P_s^{M_3}(1-P_s)^{L_2 - M_3}$$
其中 $M_2, M_3$ 分别是准备阶段和确认阶段中单个节点成功接收到的消息数量。最后计算得到PBFT发生视图变化的概率为 
$$P_v = 1 - P_{\bar{v}} = 1 - \sum_{L_1 = 2f}^{3f}C_{3f}^{L_1}P_s^{L_1}(1 - P_s)^{3f - L_1}\cdot(\sum_{L_2 = 2f+1}^{3f+1}P_{s2}^{L_2}(1 - P_{s2})^{3f+1 - L_2})\cdot(\sum_{L_3 = 2f+1}^{3f+1}P_{s3}^{L_3}(1 - P_{s3})^{3f+1 - L_3}).$$

## 通信资源开销

### 无线区块链共识算法通信开销分析

竞争类的共识算法生成一个区块所需要的时间：
* 打包生成区块的时间：毫秒级
* 竞争获取出块权限的时间：不同方式时间不同，比如：PoW是分级，PoS是秒级
* 广播时延：秒级
* 验证区块的时间：毫秒级
竞争类公式算法以PoW为例，生成区块的时间与寻找满足目标的随机数所需的时间大致相同(因为已经达到了分级，因此毫秒级和秒级的时间可以基本忽略)。因此PoW生成一个区块的时间 $T_1\approx T_d = \frac{D}{Nr_1}$，其中 $r_1$ 是节点的算力。在PoS算法中，主要考虑广播时延作为主要的通信开销，区块验证时间也可以加入考虑。 

协同类共识算法生成一个区块的时间：
* 打包生成一个区块；毫秒级
* 广播时延；秒级
* 验证区块的时间：毫秒级
协同类共识算法主要是广播时延 $T_b$ 作为通信开销，区块验证时间 $T_c$ 也可以作为考虑的一部分。以PBFT为例，当无视图更换时，生成一个区块的通信开销为 $T_{PBFT} = 3T_b$；当视图发生更换时，所需要的时间开销是 $T_{PBFT} = 2T_b$。

计算生成一个有效区块所需要的通信次数
* 竞争类共识算法生成一个区块所需要的通信开销：假设链分叉时生成一个区块的通信次数为 $C_f$；不存在链分叉时生成一个区块的通信次数是 $C_{\bar{f}}$，因此生成一个区块的平均通信次数为 $C = (1 - P_{fork})C_{\bar{f}} + P_{fork}C_f$
  * 无链分叉：在 $T_1$ 时间内生成一个有效区块，即交易到达速率为 $\lambda$，那么交易数量为 $\lambda T_1$。计算得到 $C_{\bar{f}} = \lambda T_1(N - 1) + N - 1$；
  * 链分叉：在 $T_1$ 内生成一个区块，在 $T_F$ 内生成一个分叉快。计算得到分叉时的通信数为 $C_f = C_{\bar{f}} + \lambda T_F(N-1) + N - 1$。
根据 PoW中存在 $T_F = \frac{N}{N-M-1}T_1$，计算得到PoW生成一个有效区块的通信次数为 $C_{pow} = (1 - P_{fork})C_{\bar{f}} + P_{fork}C_f$。
* 协同类共识算法生成一个区块所需要的通信开销：假设生成一个有效区块时，视图不发生变化是的通信次数为 $C_{bar{v}}$；视图发生变化时的通信次数为 $C_v$。假设生成一个有效区块之前发生了 $m$ 次视图变化。以PBFT为例，生成一个有效区块的通信次数为：
  $$C_{PBFT} = \left\{
      \begin{aligned}
      & \sum_{m=0}^\infty P_v^m(1 - P_v)(mC_v + C_{\bar{v}}), \text{if } P_v\neq 1, \\
      & \infty, \text{ if } P_v = 1.
      \end{aligned}
      \right.$$
  * 无视图变化：PBFT算法中无视图变化是，在 $T_2$ 时间内生成一个有效区块，假设交易到达速率为 $\lambda$，则交易到达数量为 $\lambda T_2$。计算得到无视图变化时的通信次数为 $C_{\bar{v}} = \lambda T_2(N-1) + N + 2N(N-1)$；
  * 视图变化：当PBFT发生视图变化时，则在 $T_2$ 时间内执行PBFT协议失败，在 $T_v$ 时间内执行试图变换协议。这段时间内的交易到达数为 $\lambda T_v$，增加的通信数是 $\lambda T_v(N-1)$，记更换视图的通信数量为 $C_+$，则视图更换时的通信数为 $C_v = C_{\bar{v}} + \lambda T_v(N-1) + C_+$，其中 $C_+ = P\{L_1 < 2f + 1\}\cdot [N-1 + N(N-1)] + P\{L_2 < 2f | L_1 \geq 2f + 1\}[N - 1 + N(N-1)] + P\{L_3 < 2f |L_1 \geq 2f + 1, L_2 \geq 2f\}[N-1 + 2N(N-1)]$。
  最后计算得到在PBFT中平均通信数量为
  $$C_{PBFT} = \left\{
      \begin{aligned}
      & \frac{P_v}{1 - P_v}C_v + C_{\bar{v}}, \text{if } P_v\neq 1, \\
      & \infty, \text{ if } P_v = 1.
      \end{aligned}
      \right.$$

### 通信资源对无限区块链性能指标的影响

共识过程对对通信资源的巨大需求意味着它在端到端延迟中占据了更大的比例，同时也限制了区块链的端到端吞吐量。区块链的共识过程决定了性能，因此需要分析共识过程的通信资源的影响力。

* **安全边界的影响**：对于协同类的共识算法而言，在无线区块链网络通信资源较少的情况下，节点之间的**冲突**（基于竞争的通信系统）或较长的**排队时间**（在基于授权的通信系统中）更有可能发生在多路访问中，因此需要更长的时间来完成所有所需的确认。但是，使用超时设置可能会由于有限的通信资源供应导致较少的节点确认，这可能会降低网络的安全级别，因为它需要至少 50% 的节点确认。电源是另一个可以影响安全级别的领域。更高的**传输功率**可以实现更广泛的无线覆盖。因此，更多的节点被通知，并且可能有更多的节点可以确认交易，从而导致更高的安全级别。典型的无线区块链网络面临来自节点受损和通信故障的安全威胁。在最坏的情况下，恶意节点不仅会发送虚假信息，还会通过频谱干扰和欺骗来干扰网络。这种攻击会降低无限区块链网络的安全性。 
* **节点扩展性影响**：对于协同类的共识算法而言，通信资源是决定区块链可扩展性的重要因素。无线区块链网络的可扩展性会受到传输功率的影响。传输功率的大小会决定了覆盖范围的大小，在节点密度固定时，可扩展性会比较小。虽然竞争类共识算法的可扩展性对于通信资源的敏感度不如协同类，但是覆盖面积会使得传输功率成为竞争类共识算法的瓶颈。
* **吞吐量和延迟影响**：这两个指标是由区块链协议和通信资源供应共同决定。在协同类共识算法中，更多的通信资源将使每个阶段更快地完成，从而提高交易吞吐量。更大的可用通信资源（如频谱、带宽和功率）可以产生低延迟区块链。传输功率和通信协议也是吞吐量和延迟的决定因素。更高的传输功率覆盖更广泛的范围。因此共识只需要较少甚至不需要继电器/路由器，进一步减少通信时间。网络大小还决定了可以记录到区块链的交易数量。

### 通信复杂度和频谱需求

* **通信复杂度**：协同类共识算法通常依赖节点之间的通信来避免恶意节点的干扰，因此通信需求比较大。比如PBFT，共识网络中节点数量为 $N$ 时，完成三个阶段的需要 $N + 2*N^2$ 次通信。竞争类共识算法，比如PoW，共识网络中节点数量为 $N$时，共识过程需要广播交易和广播区块，因此通信复杂度是 $2N$。
* 频谱需求：无线区块链网络所需的通信频谱资源。频谱需求等于传输进程的数量（与所需的资源块/传输时隙数量成正比）。无线区块链网络中所需的频谱取决于网络拓扑。最简单的情形是假设所有节点都被其他节点的无线电功率覆盖而不需要中继，那么PoW的总频谱需求是$2$，PBFT的是 $2N + 1$。
* 根据SINR模型可以测试：节点的传输功率、接收器敏感度、信道传播参数、**故障节点数量、传输间隔、端到端的成功概率（这三个固定时可以测量前三者的影响）**。

## 计算资源开销

竞争类共识算法中，PoW的算力消耗是巨大的，PoS算法的算力消耗主要是对区块的验证。协同类共识算法中算力的开销也主要是在验证区块上。

对于PoW共识算法，生成一个区块需要先找到符合目标难度的随机数。记节点的算力为 $r_1$，当PoW不发生分叉时，$T_1$ 时间内哈希次数为 $Nr_1T_1$，发生分叉时 $T_1 + T_F$ 内的哈希次数为 $Nr_1(T_1 + T_F)$，根据分叉概率 $P_{fork}$ ，生成一个有效区块所需的哈希次数为
$$H_{pow} = (1 - P_{fork})Nr_1T_1 + P_{fork}Nr_1(T_1 + T_F) \\
= Nr_1T_1 + \frac{N-1}{N}(1 - P_s)Nr_1\cdot\frac{N-M-1}{N} T_1 \\
= Nr_1T_1(2 - \frac{N }{N - M -1}P_s)$$

PoS算力的消耗是对区块的验证，记节点的算力为 $r_2$，算力的消耗考虑运行时对于区块中交易的验证。当不发生分叉时，区块验证时间为 $T_c$。根据分叉概率 $P_{fork}$ ，生成一个有效区块所需的哈希次数为
$$H_{pos} = (1 - P_{fork})Nr_2T_c + P_{fork}Nr_2(T_c + T_c) = Nr_2T_c (1+ P_{fork}).$$

协同类共识算法算力的消耗是对区块的验证，这一时间占比很小,只占区块生成时间的一部分。当算法发生视图更换时，并没有对区块的验证。因此，协同类算法算力的消耗考虑运行时对于区块中交易的验证，这一时间为 $T_c$。以PBFT为例，记节点的算力为 $r_3， m$ 是在生成有效区块之前发生视图变化的次数。可以计算出生成一个有效区块所需要的哈希次数为
$$H_{pbft} = \left\{
      \begin{aligned}
      & \sum_{m=0}^\infty P_v^m(1 - P_v)(m+1)Nr_3T_c = \frac{1}{1-P_v}Nr_23T_c, \text{if } P_v\neq 1, \\
      & \infty, \text{ if } P_v = 1.
      \end{aligned}
      \right.$$
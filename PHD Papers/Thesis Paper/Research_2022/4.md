# 基于节点稳定度的DAG区块链共识算法

## 模型假设

【简单描述：（一）区块链模型，包括节点之间的网络结构和特征、区块结构、存储结构等，例如，节点通信模型（节点拓扑或路由结构、信噪比模型等）、区块链存储模型（链式、DAG、…）等；（二）区块生成过程，包括交易打包、区块生成（包括共识）、区块上链等过程；（三）其它，包括其它与本论文紧密相关的部分。注意：重点剖析与本论文紧密相关的部分。】

###（一）区块链模型

在无线自组织网络环境中，有向无环图式存储的区块链。
* **网络模型**：考虑一个无线自组织网络，$N$个节点随意部署在一个二维平面中。记$d(u,v)$为两个节点之间的欧氏距离，$DR(v)$ 为以节点v为中心，通信半径为 $R$ 的圆盘。每个节点都拥有唯一的ID。假设节点可以在网络区域中随意移动，并且节点可以随意进入和离开这个区域。
* **区块结构**：每个节点局部地维护一个DAG区块链。各交易单元通过引用多个父交易单元的哈希最终形成有向无环图的形式。每个交易单元中包含一个交易、自身交易的哈希、父交易单元的哈希、时间戳等信息。假设节点可以被公钥基础设施支持，并且系统中采用的密码学原语是安全的，因此没有恶意实体可以伪造消息。
* **干扰和SINR模型**：采用信号干扰模型能够很好的捕获无线网络的干扰。标准信号干扰的信噪比模型为 
$$SINR(u,v) =\frac{S}{I+N}\geq \beta$$
其中 $S = P\cdot d(u,v)^(-\alpha)$ 是节点 $v$ 接收到的节点 $u$ 的信号的功率，$P$是平均信号发射功率，在节点$v$处的干扰为
 $$I=∑_{w∈W∖u}P\cdot d(w,v)^{-\alpha} $$
其中$W$是在当前传输节点的集合，$N$为环境噪声，路径损耗指数为$α∈(2,6]$，阈值$β>1$取决于节点的硬件。假设节点可以进行物理载波监听。

###（二）区块生成过程
	
* **交易的生成和广播**：节点生成新交易根据主链相关性选择父单元，广播交易到网络。其他节点验证新交易的合法性后将交易链接上本地区块链。
* **见证交易的生成和广播**：根据节点的稳定度用随机抽签算法选举见证委员会成员和首领。首领节点生成交易并选择父交易单元后将新交易广播到见证委员会。见证委员会内部执行基于门限签名的一致性协议达成共识，最终将交易单元添加到本地区块链上并广播见证交易单元到网络。
* **交易确认**：根据见证交易单元确定主链并为每一个交易单元分配主链号全局排序。主链上稳定见证单元之前的交易单元都是固定不变的，因此这些交易单元被确认。此时被确认的交易单元的交易费用将会被分发给最小子交易单元和最近子见证单元。

###（三）其它

## 研究问题

【从技术层面描述：各个问题产生的背景和原因，针对每个问题分别给出若干个可能可行的方案。重点描述“研究问题”产生的原因和进行研究的必要性，对问题分析得越清晰、透彻，越有利于后面的研究；对方案只需进行简单描述，在下一节中再详细描述研究方案。】

无线自组织网络上的区块链系统的扩展性是有限的，更改区块链的结构可以提高区块链的扩展性加快交易处理效率。采用DAG作为存储结构的区块链系统可以并行处理交易，且节点数量的增加只会提高交易的处理效率，最终提高扩展性。但是，当交易流低时旧的交易会出现确认时延长甚至无法达成共识的问题。因此，需要设计适用于无线自组织网络的DAG区块链共识算法。
* **交易确认延时长**：原因？【无线设备网络资源有限且数量庞大，区块共识延时会受限于节点带宽】方案？【减小区块的规模提高区块达成共识的速率，降低区块确认时延；采用DAG区块链形式并发处理交易，即使拥有大量的无线设备，也能快速确认交易，并且提高扩展性】
* **交易率低时无法确认交易**：原因？【节点动态性高拓扑变化大，当节点生成交易数量低时无法通过交易数量来确认旧交易】方案？【主链方式来确认交易，即使交易数量少也能最终确认交易；采用委员会投票的方式确认交易可以确保最终所有交易最终都会被确认；】

## 研究方案

【详细描述“研究问题”中各方案的关键技术方案或算法，包括：方案或算法的细节、重点和难点、该技术方案解决“研究问题”中的哪个问题等。】

DAG区块链中节点可以同时生成交易，采用构建主链为交易分配主链号确认交易并解决冲突交易单元的问题。根据见证交易单元选择系统主链并且确定主链上的稳定点，稳定点之前的所有交易单元可以被确定全序。根据这个全序可以解决冲突交易单元，全序中最早出现的交易单元是合法的，另一个则是非法的。见证交易单元需要值得信任的节点生成，因此需要设计一个基于可信见证委员会DAG区块链共识算法。

###（一）定义稳定度

区块链系统中，新节点加入后要质押金钱获得在系统中活动的时间。活动的时长与交付的押金成正比。

记 $T_{active}$为节点在区块链系统中的剩余活跃时间，记 $r$ 为节点在最近 $K$ 个见证交易中参与共识比值，定义节点的稳定度为 
$$N_{stability}= \alpha\times T_{active} + \beta\times r$$
其中，权重系数 $\alpha, \beta$ 可根据偏好设置。在区块链系统运行初期，见证交易数量不足K个时记节点的共识比 $r$ 为零，此时节点的稳定度主要受节点的活动时间的影响。
<font color = red>
重点：计算节点的剩余活动时间、节点的共识比和这两个度量的权重系数。
难点：计算影响节点稳定度的度量的权重系数，测量节点的共识比，计算其他节点的稳定度，验证首领节点的合法性。
解决的问题：解决工作量证明选取首领节点消耗巨大算力，解决首领节点突然离开系统导致，押金机制也可以防止敌手发起女巫攻击。
</font>

###（二）共识算法

DAG区块链系统需要一个基于见证委员会的共识算法决定主链对交易全局排序。基于见证委员会的共识算法主要是节点生成新交易后，根据见证交易选择父单元。从顶端交易单元往创世交易单元回溯的路径可以找到一条主链。根据见证交易单元最终确定一条系统主链，并确定主链上的稳定点。共识算法中见证委员会机制主要包括几个部分：委员会成员和首领节点的选举、一致性协议和委员会重置。我们根据节点的稳定度决定节点被选中的概率。一致性协议则是采用门限签名方式，让委员会成员不需要二次通信就能对区块达成一致。
* **见证委员会选举**：采用随机抽签算法选举委员会节点，将上一个见证交易单元的哈希作为随机种子，通过随机可验证函数计算得到抽签结果和证明，其他节点可以根据证明验证该节点的合法性。
	* **轮盘赌抽签**
    随机抽签算法根据节点的稳定度决定节点被选中的概率。记$w_i$ 是节点 $i (i = 1, \cdots N)$ 的稳定度，所有节点的稳定度之和为 $W= ∑_iw_i$ ，那么节点i被选中的概率为 $p_i=  \frac{w_i}{W}$ 且有 $∑_{i=1}^Np_i=1$。为了确定被选中的节点，将区间[0,1]分为连续的多个区间
    $$[0,∑_{k=0}^i p_k],i=1],(∑_{k=0}^{i-1} p_k ,∑_{k=0}^i p_k],i=2,…, N.$$
    随机可验证函数将区块的高度和最终签名作为输入计算得到一个值和证明
    $$(value,proof)=VRF(sk,Height||Signature_group)$$
    满足 $\frac{value}{2^{bits(value)}} > \lambda$ 的前 $C$ 个节点被选举为委员会成员。
	* **验证抽签结果**
    根据随机抽签算法输出的随机选举值和证明，其他节点也可以验证首领选举结果的合法性。
    $$result=VerifyVRF(pk, value, proof, Height,Signature_group)$$
    如果验证结果为 $result= 1$，则委员会节点的验证成功，该成员是合法的；如果结果为 $result= 0$，则委员会节点的合法性将不被承认。
* **首领节点选举**：每个委员会将有一个任期，每个任期又分为多个轮。每轮需要选举首领节点生成区块在委员会内部达成一致。选择委员会中相互之间通信资源消耗少的节点作为首领，提高委员会达成一致的效率。
    * **【方案一】** 通过路由算法委员会成员可以得知到其他成员节点的跳数，最终选择平均跳数最少的节点作为首领。记委员会成员数量为$C$，则委员会节点到其他节点跳数的矩阵记为
    $$H = \begin{bmatrix}
    h_{11}  &   h_{12}  &   \cdots  &  h_{1C}\\
    h_{21}  &   h_{22}  &   \cdots  &  h_{2C}\\
    \vdots  &   \vdots  &   \vdots  &  \vdots\\
    h_{C1}  &   h_{C2}  &   \cdots  &  h_{CC}\\
    \end{bmatrix}$$
    其中 $h_{ij}$ 表示节点 $i$ 到节点 $j$ 之间的路由跳数，当 $i=j$ 时 $h_{ij}=0$，表示节点到其自身的跳数为零。
    * **【方案二】** 在无线网络通信中，节点的欧式距离会反映节点之间的通信情况。因此可以根据节点的位置和通信半径，采用最大独立子集的方式构建节点之间的通信骨架，最终选择出比较中心的节点作为首领。
* **一致性协议**：确定委员会成员和首领之后，首领节点会生成和分发密钥份额给委员会其他成员。首领节点广播新的交易给委员会成员。委员会成员会验证交易、首领节点的合法性以及当前签名份额的有效性。当对于交易的签名份额数量达到阈值后会组成见证交易的最终签名，委员会对见证交易达成一致。委员会成员将见证交易单元链接到DAG区块链并广播给其他非委员会成员。接收到确认区块的节点验证区块合法性成功后将见证交易连接到本地链上。
* **委员会重置**：委员会任期结束之后，需要更换委员会成员。根据委员会的容错率来决定更换委员会成员的数量。为了更好的确保系统的安全性，委员会成员每次最多只更换稳定度最低的 $\lfloor\frac{C-1}{4}\rfloor$ 个节点。
* **主链机制**：可以根据见证交易单元来确定系统主链，并且确定稳定点。系统主链中稳定点之前的交易单元是完全相同的，因此可以为主链上的交易单元分配主链号，稳定点之前的所有交易可以被确定全序。对于冲突交易只承认最早出现交易的合法性，解决了交易双花的问题。
<font color = red>
重点：利用随机抽签算法选举委员会成员，基于跳数或者位置的方式选举首领节点。采用基于门限签名的一致性协议在委员会内对见证交易达成一致。
难点：快速计算每个节点的稳定度和被选中概率，快速选举委员会成员和首领。获取其他节点的跳数信息和位置信息。计算门限签名中密钥份额的计算和分发，区块签名份额的收集和最终组合。
解决的问题：解决见证交易的信任问题，确保见证交易的可信性。解决见证委员会成员稳定性问题，确保每个被选中成为委员会成员都是可信的且短期内都不会离开系统。
</font>

###（三）奖惩机制
	
* **奖励机制**：当一个交易单元被确认后，该交易的交易费会分发给其最小子交易和稳定见证交易所属的见证委员会成员。通过激励机制可以激励节点的活性以及节点成为见证委员会成员的积极性，进而提高系统的安全性。
* **惩罚机制**：如果节点在未到活动时间结束之前离开系统，则会扣除部分押金，如果发现有节点作恶也会扣除押金，从而降低节点离线和作恶的机会。

<font color = red>
重点：采用奖励机制提高节点的活性和系统的安全性，使用惩罚机制降低节点作恶的动机。
难点：交易费用的计算，快速分配奖励给委员会成员。
解决的问题：解决节点缺乏活性问题，奖励机制可以激励节点积极地参与共识维护区块链。节点如果长期离线就会蒙受经济损失，解决节点长期离线的问题。
</font>

## 仿真实验

【描述：（一）实验目标，（二）实验方案（详细的实验方案，包括实验环境、实验步骤等），（三）技术难点（目前的技术难点、还需要补充的知识等）。】

###（一）实验目标

通过仿真实验测试交易吞吐量和交易确认延时分析区块系统的性能。
* **交易吞吐量**：单位时间内处理交易的数量；
* **交易确认延时**：交易确认的平均时延。

在仿真实验中需要测试不同交易到达率、节点数量、节点密度的情况下DAG区块链系统的交易吞吐量和交易确认延时。

考虑网络带宽，网络通信协议、单位时隙大小、编程语言、运行设备、测试次数等。

影响因素包括交易到达率、网络大小、节点密度等。

###（二）实验方案

【如何来完成实验？在自己设计的区块链中采集数据进行分析？在公链上进行实验？实验步骤是什么？】

无线自组织网络中测试区块链系统的性能需要在自己设计一个区块链进行数据采集和分析。实验步骤如下：
* **搭建无线自组织网络**：每个节点都以相同的移动速率在网络区域中随机移动，且在区域中的活动时间是有限的。对于节点之间的通信采用CSMA/CA作为通信协议。
* **记录节点的活动时间**：为每个节点赋予不同的活动时间，当活动时间结束则该节点离开网络。记录节点进入网络的时间。
* **生成交易**：为每个节点设置相同的交易到达率，构造一批不同的交易，确保他们的哈希不同，并记录开始发送交易的时间。
* **选举见证委员会成员**：记录委员会选举开始的时间,根据任期长度记录委员会结束的时间。并记录每个见证交易的发送时间。
* **确认交易**：根据见证交易单元确定系统主链和稳定点。对于稳定点之前的交易可以被确认，并记录交易的确认时间。
* **计算交易确认延时**：记录两个稳定点之间交易的确认时延，可以得到最大确认时延、最小确认时延和屁股军确认时延。
* **计算平均交易吞吐量**：计算系统主链中两个稳定点之间的交易数量，除以稳定点的确认时间间隔，可以得到平均交易吞吐量。

###（三）技术难点

【根据设计的实验方案，目前的技术难点或需要学习的知识有哪些？】

* **技术难点**：在无线自组织网络上搭建区块链系统，计算稳定度依据的权重系数，获取其他节点的稳定度。节点活动起止时间记录，交易发送和确认时间记录，更换委员会成员。
* **待学习的知识**：虚拟机配置、Socket编程、C++编程语言学习。
